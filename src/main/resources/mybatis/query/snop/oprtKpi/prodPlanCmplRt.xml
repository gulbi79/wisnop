<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="snop.oprtKpi">

    <select id="prodPalnCmplRtSelect" parameterType="map" resultType="map">
		/****** [ snop.oprtKpi.prodPalnCmplRtSelect ] ******/
		#set($weekArr  = [0..4])
		#set($weekArr2  = [1..5])
		
		BEGIN
		
		    DECLARE @P_UN_RATE NUMERIC(21, 6); 
		    DECLARE @P_OB_RATE NUMERIC(21, 6);
		    DECLARE @P_EX_RATE NUMERIC(21, 6);
		    DECLARE @FQC_DATE  NVARCHAR(8);
		    
		    SELECT @P_UN_RATE = CAST (MAX (CASE WHEN CODE_CD = 'UN' THEN ATTB_1_CD ELSE NULL END) AS NUMERIC(21, 6))
		         , @P_OB_RATE = CAST (MAX (CASE WHEN CODE_CD = 'OB' THEN ATTB_1_CD ELSE NULL END) AS NUMERIC(21, 6))
		         , @P_EX_RATE = CAST (MAX (CASE WHEN CODE_CD = 'EX' THEN ATTB_1_CD ELSE NULL END) AS NUMERIC(21, 6))
		    FROM TB_MST_CODE
		    WHERE GROUP_CD = 'COMPLIANCE_RATE';
		    
		    #if($_parameter.resultCurrYn == "Y")
		    	SELECT @FQC_DATE = CONVERT(VARCHAR, DBO.UFN_GETDATE(), 112);
		    #else
		    	SELECT @FQC_DATE = CONVERT(VARCHAR, CONVERT(DATETIME, B1.YYYYMMDD) + CONVERT(INTEGER, 7), 112)
				FROM TB_MST_CALENDAR B1 WITH(NOLOCK)
				WHERE B1.YEARWEEK = @{fromWeek}
				  AND B1.DAY_NM = 'SUN';
		    #end
		    
		    DECLARE @P_W0_REQ_SUN  NVARCHAR(8) = @{swFromDate}; /*일요일*/
		    DECLARE @P_W0_REQ_SAT  NVARCHAR(8) = @{swToDate}; /*토요일*/
		    DECLARE @P_W0_WEEK     NVARCHAR(6) = (SELECT YEARWEEK FROM TB_MST_CALENDAR WHERE YYYYMMDD = @{swFromDate});
		    
		    DECLARE @P_W0_REQ_TUE  NVARCHAR(8) = CONVERT (NVARCHAR (30), DATEADD (DAY, 2, CAST (@P_W0_REQ_SUN AS DATE)), 112); /*화요일*/
		    DECLARE @P_W0_REQ_THU  NVARCHAR(8) = CONVERT (NVARCHAR (30), DATEADD (DAY, 4, CAST (@P_W0_REQ_SUN AS DATE)), 112); /*목요일*/
		    DECLARE @P_W0_REQ_FRI  NVARCHAR(8) = CONVERT (NVARCHAR (30), DATEADD (DAY, 5, CAST (@P_W0_REQ_SUN AS DATE)), 112); /*금요일*/
		    
			#foreach( $i in $weekArr2 )
		  	#set( $idx = $foreach.count - 1 )
			    DECLARE @P_W${i}_REQ_SUN  NVARCHAR(8) = CONVERT (NVARCHAR (30), DATEADD (DAY, -7, CAST (@P_W${idx}_REQ_SUN AS DATE)), 112); /*일요일*/
			    DECLARE @P_W${i}_REQ_SAT  NVARCHAR(8) = CONVERT (NVARCHAR (30), DATEADD (DAY, -7, CAST (@P_W${idx}_REQ_SAT  AS DATE)), 112); /*토요일*/
			    DECLARE @P_W${i}_WEEK     NVARCHAR(6) = (SELECT YEARWEEK FROM TB_MST_CALENDAR WHERE YYYYMMDD = CONVERT(NVARCHAR(8), DATEADD(DAY, (-7 * ${i}), CAST(@{swFromDate} AS DATE)), 112)); /*주차*/
			    DECLARE @P_W${i}_REQ_TUE  NVARCHAR(8) = CONVERT (NVARCHAR (30), DATEADD (DAY, 2, CAST (@P_W${i}_REQ_SUN AS DATE)), 112); /*화요일*/
			    DECLARE @P_W${i}_REQ_THU  NVARCHAR(8) = CONVERT (NVARCHAR (30), DATEADD (DAY, 4, CAST (@P_W${i}_REQ_SUN AS DATE)), 112); /*목요일*/
			    DECLARE @P_W${i}_REQ_FRI  NVARCHAR(8) = CONVERT (NVARCHAR (30), DATEADD (DAY, 5, CAST (@P_W${i}_REQ_SUN AS DATE)), 112); /*금요일*/
			#end
		    
		    WITH W_ITEM AS 
			(
			    <include refid="snop.common.t_itemCust_subRouting" />
			),
			W_INSP AS 
			(
#if($_parameter.week == "STD")
			    SELECT ISP.COMPANY_CD
			         , ISP.BU_CD
			         , ISP.ITEM_CD
			         , ISP.LOT_SIZE
			         , ISP.INSP_QTY
			         , ISP.GOODS_QTY
			         , ISP.DEFECT_QTY
			         , (ISP.GOODS_QTY - ISP.SPEC_QTY) AS CMPL_QTY
			         , ISP.SPEC_QTY
			         , NULL AS ADJ_INSP_REQ_DATE
			         , ISP.RELEASE_DATE
			         , NULL YEARWEEK
			         , NULL QTY
			         , NULL FLAG
			    FROM TB_DYN_INSPECTION ISP WITH (NOLOCK)
			    WHERE ISP.COMPANY_CD = @{GV_COMPANY_CD}
			      AND ISP.BU_CD      = @{GV_BU_CD} 
			      AND ISP.PLANT_CD   = 'WF01'
			      AND DEL_FLAG       = 'N'
			      AND RELEASE_DATE BETWEEN @P_W5_REQ_SUN AND @P_W0_REQ_SAT
				UNION ALL
          		SELECT DGP.COMPANY_CD
					 , DGP.BU_CD
		             , DGP.ITEM_CD
		             , DGP.GR_QTY AS LOT_SIZE
		             , DGP.GR_QTY AS INSP_QTY
		             , DGP.GR_QTY AS GOODS_QTY
		             , NULL AS DEFECT_QTY
		             , DGP.GR_QTY AS CMPL_QTY
		             , NULL AS SPEC_QTY
		             , NULL AS ADJ_INSP_REQ_DATE
		             , DGP.GR_DATE AS RELEASE_DATE
		             , NULL YEARWEEK
		             , NULL QTY
		             , NULL FLAG
				FROM TB_DYN_GR_PROD DGP WITH(NOLOCK)
		        WHERE DGP.COMPANY_CD = @{GV_COMPANY_CD}
		          AND DGP.BU_CD = @{GV_BU_CD} 
		          AND DGP.PLANT_CD = 'WF01'
		          AND DGP.GR_DATE BETWEEN @P_W5_REQ_SUN AND @P_W0_REQ_SAT
		          AND EXISTS (
								SELECT 1
		                        FROM TB_MST_ITEM_PLANT MIP WITH(NOLOCK)
		                        WHERE MIP.COMPANY_CD = DGP.COMPANY_CD
		                          AND MIP.BU_CD = DGP.BU_CD
		                          AND MIP.PLANT_CD = DGP.PLANT_CD
		                          AND MIP.ITEM_CD = DGP.ITEM_CD
		                          AND MIP.ITEM_TYPE = '20'
		                          AND MIP.PROCUR_TYPE IN ('MG', 'MH')
		                     )			      
			    UNION ALL
			    
			    /*계획 수량*/
			    SELECT PP.COMPANY_CD
			         , PP.BU_CD
			         , PP.ITEM_CD
			         , NULL
			         , NULL
			         , NULL
			         , NULL
			         , NULL
			         , NULL
			         , NULL
			         , NULL
			         , YEARWEEK
			         , PP.QTY
			         , 'W_4' AS FLAG
			    FROM TB_DYN_PROD_PLAN PP WITH(NOLOCK)
	          	WHERE COMPANY_CD = @{GV_COMPANY_CD}
			      AND BU_CD      = @{GV_BU_CD} 
			      AND YEARWEEK   = @P_W4_WEEK
	          	UNION ALL
	          	SELECT PP.COMPANY_CD
		             , PP.BU_CD
		             , PP.ITEM_CD
		             , NULL
		             , NULL
		             , NULL
		             , NULL
		             , NULL
		             , NULL
		             , NULL
		             , NULL
		             , YEARWEEK
		             , PP.QTY
		             , 'W_3' AS FLAG
	          	FROM TB_DYN_PROD_PLAN PP WITH(NOLOCK)
	          	WHERE COMPANY_CD = @{GV_COMPANY_CD}
			      AND BU_CD      = @{GV_BU_CD} 
			      AND YEARWEEK   = @P_W3_WEEK
	          	UNION ALL
	          	SELECT PP.COMPANY_CD
			         , PP.BU_CD
			         , PP.ITEM_CD
			         , NULL
			         , NULL
			         , NULL
			         , NULL
			         , NULL
			         , NULL
			         , NULL
			         , NULL
			         , YEARWEEK
			         , PP.QTY
			         , 'W_2' AS FLAG
	          	FROM TB_DYN_PROD_PLAN PP WITH(NOLOCK)
	          	WHERE COMPANY_CD = @{GV_COMPANY_CD}
			      AND BU_CD      = @{GV_BU_CD} 
			      AND YEARWEEK   = @P_W2_WEEK
	          	UNION ALL
	          	SELECT PP.COMPANY_CD
			         , PP.BU_CD
			         , PP.ITEM_CD
			         , NULL
			         , NULL
			         , NULL
			         , NULL
			         , NULL
			         , NULL
			         , NULL
			         , NULL
			         , YEARWEEK
			         , PP.QTY
			         , 'W_1' AS FLAG
	          	FROM TB_DYN_PROD_PLAN PP WITH(NOLOCK)
	          	WHERE COMPANY_CD = @{GV_COMPANY_CD}
			      AND BU_CD      = @{GV_BU_CD} 
			      AND YEARWEEK   = @P_W1_WEEK
	          	UNION ALL
	          	SELECT PP.COMPANY_CD
			         , PP.BU_CD
			         , PP.ITEM_CD
			         , NULL
			         , NULL
			         , NULL
			         , NULL
			         , NULL
			         , NULL
			         , NULL
			         , NULL
			         , YEARWEEK
			         , PP.QTY
			         , 'W_0' AS FLAG
	          	FROM TB_DYN_PROD_PLAN PP WITH(NOLOCK)
          		WHERE COMPANY_CD = @{GV_COMPANY_CD}
			      AND BU_CD      = @{GV_BU_CD} 
			      AND YEARWEEK   = @P_W0_WEEK
			      
	          	/*선행생산 계획*/
	          	UNION ALL
	          	SELECT PP.COMPANY_CD
			         , PP.BU_CD
			         , PP.ITEM_CD
			         , NULL
			         , NULL
			         , NULL
			         , NULL
			         , NULL
			         , NULL
			         , NULL
			         , NULL
			         , NULL
			         , PP.QTY
			         , 'W_1_PLAN' AS FLAG
	          	FROM TB_HIS_APS_PROD_PLAN_DAILY PP WITH(NOLOCK)
				WHERE PP.COMPANY_CD = @{GV_COMPANY_CD}
			      AND PP.BU_CD      = @{GV_BU_CD} 
			      AND PP.PLAN_ID = @P_W1_REQ_THU
	         	  AND PP.YYYYMMDD BETWEEN @P_W1_REQ_THU AND @P_W1_REQ_SAT
	         	UNION ALL
	          	SELECT PP.COMPANY_CD
			         , PP.BU_CD
			         , PP.ITEM_CD
			         , NULL
			         , NULL
			         , NULL
			         , NULL
			         , NULL
			         , NULL
			         , NULL
			         , NULL
			         , NULL
			         , PP.QTY
			         , 'W_2_PLAN' AS FLAG
	          	FROM TB_HIS_APS_PROD_PLAN_DAILY PP WITH(NOLOCK)
				WHERE PP.COMPANY_CD = @{GV_COMPANY_CD}
			      AND PP.BU_CD      = @{GV_BU_CD} 
			      AND PP.PLAN_ID = @P_W2_REQ_THU
	         	  AND PP.YYYYMMDD BETWEEN @P_W2_REQ_THU AND @P_W2_REQ_SAT
	         	UNION ALL
	          	SELECT PP.COMPANY_CD
			         , PP.BU_CD
			         , PP.ITEM_CD
			         , NULL
			         , NULL
			         , NULL
			         , NULL
			         , NULL
			         , NULL
			         , NULL
			         , NULL
			         , NULL
			         , PP.QTY
			         , 'W_3_PLAN' AS FLAG
	          	FROM TB_HIS_APS_PROD_PLAN_DAILY PP WITH(NOLOCK)
				WHERE PP.COMPANY_CD = @{GV_COMPANY_CD}
			      AND PP.BU_CD      = @{GV_BU_CD} 
			      AND PP.PLAN_ID = @P_W3_REQ_THU
	         	  AND PP.YYYYMMDD BETWEEN @P_W3_REQ_THU AND @P_W3_REQ_SAT
	         	UNION ALL
	          	SELECT PP.COMPANY_CD
			         , PP.BU_CD
			         , PP.ITEM_CD
			         , NULL
			         , NULL
			         , NULL
			         , NULL
			         , NULL
			         , NULL
			         , NULL
			         , NULL
			         , NULL
			         , PP.QTY
			         , 'W_4_PLAN' AS FLAG
	          	FROM TB_HIS_APS_PROD_PLAN_DAILY PP WITH(NOLOCK)
				WHERE PP.COMPANY_CD = @{GV_COMPANY_CD}
			      AND PP.BU_CD      = @{GV_BU_CD} 
			      AND PP.PLAN_ID = @P_W4_REQ_THU
	         	  AND PP.YYYYMMDD BETWEEN @P_W4_REQ_THU AND @P_W4_REQ_SAT
	         	UNION ALL
	          	SELECT PP.COMPANY_CD
			         , PP.BU_CD
			         , PP.ITEM_CD
			         , NULL
			         , NULL
			         , NULL
			         , NULL
			         , NULL
			         , NULL
			         , NULL
			         , NULL
			         , NULL
			         , PP.QTY
			         , 'W_5_PLAN' AS FLAG
	          	FROM TB_HIS_APS_PROD_PLAN_DAILY PP WITH(NOLOCK)
				WHERE PP.COMPANY_CD = @{GV_COMPANY_CD}
			      AND PP.BU_CD      = @{GV_BU_CD} 
			      AND PP.PLAN_ID = @P_W5_REQ_THU
	         	  AND PP.YYYYMMDD BETWEEN @P_W5_REQ_THU AND @P_W5_REQ_SAT
#elseif($_parameter.week == "SALES")
				SELECT ISP.COMPANY_CD
			         , ISP.BU_CD
			         , ISP.ITEM_CD
			         , ISP.LOT_SIZE
			         , ISP.INSP_QTY
			         , ISP.GOODS_QTY
			         , ISP.DEFECT_QTY
			         , (ISP.GOODS_QTY - ISP.SPEC_QTY) AS CMPL_QTY
			         , ISP.SPEC_QTY
			         , NULL AS ADJ_INSP_REQ_DATE
			         , ISP.RELEASE_DATE
			         , NULL YEARWEEK
			         , NULL QTY
			         , 'W_0_ETC' FLAG
			    FROM TB_DYN_INSPECTION ISP WITH (NOLOCK)
				INNER JOIN TB_MST_ITEM_PLANT MIP WITH(NOLOCK)
            	   ON MIP.COMPANY_CD = ISP.COMPANY_CD
           		  AND MIP.BU_CD = ISP.BU_CD
           		  AND MIP.PLANT_CD = ISP.PLANT_CD
           		  AND MIP.ITEM_CD = ISP.ITEM_CD
			    WHERE ISP.COMPANY_CD = @{GV_COMPANY_CD}
			      AND ISP.BU_CD      = @{GV_BU_CD} 
			      AND ISP.PLANT_CD   = 'WF01'
			      AND ISP.DEL_FLAG   = 'N'
				  AND ISP.RELEASE_DATE <![CDATA[>=]]> @P_W0_REQ_SUN
            	  AND ISP.RELEASE_DATE <![CDATA[<=]]> CASE MIP.CLEANING_FLAG WHEN 'Y' THEN @P_W0_REQ_TUE WHEN 'N' THEN @P_W0_REQ_THU END
				UNION ALL
          		SELECT DGP.COMPANY_CD
					 , DGP.BU_CD
		             , DGP.ITEM_CD
		             , DGP.GR_QTY AS LOT_SIZE
		             , DGP.GR_QTY AS INSP_QTY
		             , DGP.GR_QTY AS GOODS_QTY
		             , NULL AS DEFECT_QTY
		             , DGP.GR_QTY AS CMPL_QTY
		             , NULL AS SPEC_QTY
		             , NULL AS ADJ_INSP_REQ_DATE
		             , DGP.GR_DATE AS RELEASE_DATE
		             , NULL YEARWEEK
		             , NULL QTY
		             , 'W_0_ETC' FLAG
				FROM TB_DYN_GR_PROD DGP WITH(NOLOCK)
				INNER JOIN TB_MST_ITEM_PLANT MIP WITH(NOLOCK)
            	   ON MIP.COMPANY_CD = DGP.COMPANY_CD
           		  AND MIP.BU_CD = DGP.BU_CD
           		  AND MIP.PLANT_CD = DGP.PLANT_CD
           		  AND MIP.ITEM_CD = DGP.ITEM_CD
		        WHERE DGP.COMPANY_CD = @{GV_COMPANY_CD}
		          AND DGP.BU_CD = @{GV_BU_CD}
		          AND DGP.PLANT_CD = 'WF01'
		          AND DGP.GR_DATE <![CDATA[>=]]> @P_W0_REQ_SUN
            	  AND DGP.GR_DATE <![CDATA[<=]]> CASE MIP.CLEANING_FLAG WHEN 'Y' THEN @P_W0_REQ_TUE WHEN 'N' THEN @P_W0_REQ_THU END
		          AND EXISTS (
								SELECT 1
		                        FROM TB_MST_ITEM_PLANT MIP WITH(NOLOCK)
		                        WHERE MIP.COMPANY_CD = DGP.COMPANY_CD
		                          AND MIP.BU_CD = DGP.BU_CD
		                          AND MIP.PLANT_CD = DGP.PLANT_CD
		                          AND MIP.ITEM_CD = DGP.ITEM_CD
		                          AND MIP.ITEM_TYPE = '20'
		                          AND MIP.PROCUR_TYPE IN ('MG', 'MH')
		                     )
				
				UNION ALL
				SELECT ISP.COMPANY_CD
			         , ISP.BU_CD
			         , ISP.ITEM_CD
			         , ISP.LOT_SIZE
			         , ISP.INSP_QTY
			         , ISP.GOODS_QTY
			         , ISP.DEFECT_QTY
			         , (ISP.GOODS_QTY - ISP.SPEC_QTY) AS CMPL_QTY
			         , ISP.SPEC_QTY
			         , NULL AS ADJ_INSP_REQ_DATE
			         , ISP.RELEASE_DATE
			         , NULL YEARWEEK
			         , NULL QTY
			         , 'W_1_ETC' FLAG
			    FROM TB_DYN_INSPECTION ISP WITH (NOLOCK)
				INNER JOIN TB_MST_ITEM_PLANT MIP WITH(NOLOCK)
            	   ON MIP.COMPANY_CD = ISP.COMPANY_CD
           		  AND MIP.BU_CD = ISP.BU_CD
           		  AND MIP.PLANT_CD = ISP.PLANT_CD
           		  AND MIP.ITEM_CD = ISP.ITEM_CD
			    WHERE ISP.COMPANY_CD = @{GV_COMPANY_CD}
			      AND ISP.BU_CD      = @{GV_BU_CD} 
			      AND ISP.PLANT_CD   = 'WF01'
			      AND ISP.DEL_FLAG   = 'N'
				  AND ISP.RELEASE_DATE <![CDATA[>=]]> @P_W1_REQ_SUN
            	  AND ISP.RELEASE_DATE <![CDATA[<=]]> CASE MIP.CLEANING_FLAG WHEN 'Y' THEN @P_W1_REQ_TUE WHEN 'N' THEN @P_W1_REQ_THU END
				UNION ALL
          		SELECT DGP.COMPANY_CD
					 , DGP.BU_CD
		             , DGP.ITEM_CD
		             , DGP.GR_QTY AS LOT_SIZE
		             , DGP.GR_QTY AS INSP_QTY
		             , DGP.GR_QTY AS GOODS_QTY
		             , NULL AS DEFECT_QTY
		             , DGP.GR_QTY AS CMPL_QTY
		             , NULL AS SPEC_QTY
		             , NULL AS ADJ_INSP_REQ_DATE
		             , DGP.GR_DATE AS RELEASE_DATE
		             , NULL YEARWEEK
		             , NULL QTY
		             , 'W_1_ETC' FLAG
				FROM TB_DYN_GR_PROD DGP WITH(NOLOCK)
				INNER JOIN TB_MST_ITEM_PLANT MIP WITH(NOLOCK)
            	   ON MIP.COMPANY_CD = DGP.COMPANY_CD
           		  AND MIP.BU_CD = DGP.BU_CD
           		  AND MIP.PLANT_CD = DGP.PLANT_CD
           		  AND MIP.ITEM_CD = DGP.ITEM_CD
		        WHERE DGP.COMPANY_CD = @{GV_COMPANY_CD}
		          AND DGP.BU_CD = @{GV_BU_CD}
		          AND DGP.PLANT_CD = 'WF01'
		          AND DGP.GR_DATE <![CDATA[>=]]> @P_W1_REQ_SUN
            	  AND DGP.GR_DATE <![CDATA[<=]]> CASE MIP.CLEANING_FLAG WHEN 'Y' THEN @P_W1_REQ_TUE WHEN 'N' THEN @P_W1_REQ_THU END
		          AND EXISTS (
								SELECT 1
		                        FROM TB_MST_ITEM_PLANT MIP WITH(NOLOCK)
		                        WHERE MIP.COMPANY_CD = DGP.COMPANY_CD
		                          AND MIP.BU_CD = DGP.BU_CD
		                          AND MIP.PLANT_CD = DGP.PLANT_CD
		                          AND MIP.ITEM_CD = DGP.ITEM_CD
		                          AND MIP.ITEM_TYPE = '20'
		                          AND MIP.PROCUR_TYPE IN ('MG', 'MH')
		                     )		                     
				UNION ALL
				SELECT ISP.COMPANY_CD
			         , ISP.BU_CD
			         , ISP.ITEM_CD
			         , ISP.LOT_SIZE
			         , ISP.INSP_QTY
			         , ISP.GOODS_QTY
			         , ISP.DEFECT_QTY
			         , (ISP.GOODS_QTY - ISP.SPEC_QTY) AS CMPL_QTY
			         , ISP.SPEC_QTY
			         , NULL AS ADJ_INSP_REQ_DATE
			         , ISP.RELEASE_DATE
			         , NULL YEARWEEK
			         , NULL QTY
			         , 'W_2_ETC' FLAG
			    FROM TB_DYN_INSPECTION ISP WITH (NOLOCK)
				INNER JOIN TB_MST_ITEM_PLANT MIP WITH(NOLOCK)
            	   ON MIP.COMPANY_CD = ISP.COMPANY_CD
           		  AND MIP.BU_CD = ISP.BU_CD
           		  AND MIP.PLANT_CD = ISP.PLANT_CD
           		  AND MIP.ITEM_CD = ISP.ITEM_CD
			    WHERE ISP.COMPANY_CD = @{GV_COMPANY_CD}
			      AND ISP.BU_CD      = @{GV_BU_CD} 
			      AND ISP.PLANT_CD   = 'WF01'
			      AND ISP.DEL_FLAG   = 'N'
				  AND ISP.RELEASE_DATE <![CDATA[>=]]> @P_W2_REQ_SUN
            	  AND ISP.RELEASE_DATE <![CDATA[<=]]> CASE MIP.CLEANING_FLAG WHEN 'Y' THEN @P_W2_REQ_TUE WHEN 'N' THEN @P_W2_REQ_THU END
				UNION ALL
          		SELECT DGP.COMPANY_CD
					 , DGP.BU_CD
		             , DGP.ITEM_CD
		             , DGP.GR_QTY AS LOT_SIZE
		             , DGP.GR_QTY AS INSP_QTY
		             , DGP.GR_QTY AS GOODS_QTY
		             , NULL AS DEFECT_QTY
		             , DGP.GR_QTY AS CMPL_QTY
		             , NULL AS SPEC_QTY
		             , NULL AS ADJ_INSP_REQ_DATE
		             , DGP.GR_DATE AS RELEASE_DATE
		             , NULL YEARWEEK
		             , NULL QTY
		             , 'W_2_ETC' FLAG
				FROM TB_DYN_GR_PROD DGP WITH(NOLOCK)
				INNER JOIN TB_MST_ITEM_PLANT MIP WITH(NOLOCK)
            	   ON MIP.COMPANY_CD = DGP.COMPANY_CD
           		  AND MIP.BU_CD = DGP.BU_CD
           		  AND MIP.PLANT_CD = DGP.PLANT_CD
           		  AND MIP.ITEM_CD = DGP.ITEM_CD
		        WHERE DGP.COMPANY_CD = @{GV_COMPANY_CD}
		          AND DGP.BU_CD = @{GV_BU_CD}
		          AND DGP.PLANT_CD = 'WF01'
		          AND DGP.GR_DATE <![CDATA[>=]]> @P_W2_REQ_SUN
            	  AND DGP.GR_DATE <![CDATA[<=]]> CASE MIP.CLEANING_FLAG WHEN 'Y' THEN @P_W2_REQ_TUE WHEN 'N' THEN @P_W2_REQ_THU END
		          AND EXISTS (
								SELECT 1
		                        FROM TB_MST_ITEM_PLANT MIP WITH(NOLOCK)
		                        WHERE MIP.COMPANY_CD = DGP.COMPANY_CD
		                          AND MIP.BU_CD = DGP.BU_CD
		                          AND MIP.PLANT_CD = DGP.PLANT_CD
		                          AND MIP.ITEM_CD = DGP.ITEM_CD
		                          AND MIP.ITEM_TYPE = '20'
		                          AND MIP.PROCUR_TYPE IN ('MG', 'MH')
		                     )		    

				UNION ALL
				SELECT ISP.COMPANY_CD
			         , ISP.BU_CD
			         , ISP.ITEM_CD
			         , ISP.LOT_SIZE
			         , ISP.INSP_QTY
			         , ISP.GOODS_QTY
			         , ISP.DEFECT_QTY
			         , (ISP.GOODS_QTY - ISP.SPEC_QTY) AS CMPL_QTY
			         , ISP.SPEC_QTY
			         , NULL AS ADJ_INSP_REQ_DATE
			         , ISP.RELEASE_DATE
			         , NULL YEARWEEK
			         , NULL QTY
			         , 'W_3_ETC' FLAG
			    FROM TB_DYN_INSPECTION ISP WITH (NOLOCK)
				INNER JOIN TB_MST_ITEM_PLANT MIP WITH(NOLOCK)
            	   ON MIP.COMPANY_CD = ISP.COMPANY_CD
           		  AND MIP.BU_CD = ISP.BU_CD
           		  AND MIP.PLANT_CD = ISP.PLANT_CD
           		  AND MIP.ITEM_CD = ISP.ITEM_CD
			    WHERE ISP.COMPANY_CD = @{GV_COMPANY_CD}
			      AND ISP.BU_CD      = @{GV_BU_CD} 
			      AND ISP.PLANT_CD   = 'WF01'
			      AND ISP.DEL_FLAG   = 'N'
				  AND ISP.RELEASE_DATE <![CDATA[>=]]> @P_W3_REQ_SUN
            	  AND ISP.RELEASE_DATE <![CDATA[<=]]> CASE MIP.CLEANING_FLAG WHEN 'Y' THEN @P_W3_REQ_TUE WHEN 'N' THEN @P_W3_REQ_THU END
				UNION ALL
          		SELECT DGP.COMPANY_CD
					 , DGP.BU_CD
		             , DGP.ITEM_CD
		             , DGP.GR_QTY AS LOT_SIZE
		             , DGP.GR_QTY AS INSP_QTY
		             , DGP.GR_QTY AS GOODS_QTY
		             , NULL AS DEFECT_QTY
		             , DGP.GR_QTY AS CMPL_QTY
		             , NULL AS SPEC_QTY
		             , NULL AS ADJ_INSP_REQ_DATE
		             , DGP.GR_DATE AS RELEASE_DATE
		             , NULL YEARWEEK
		             , NULL QTY
		             , 'W_3_ETC' FLAG
				FROM TB_DYN_GR_PROD DGP WITH(NOLOCK)
				INNER JOIN TB_MST_ITEM_PLANT MIP WITH(NOLOCK)
            	   ON MIP.COMPANY_CD = DGP.COMPANY_CD
           		  AND MIP.BU_CD = DGP.BU_CD
           		  AND MIP.PLANT_CD = DGP.PLANT_CD
           		  AND MIP.ITEM_CD = DGP.ITEM_CD
		        WHERE DGP.COMPANY_CD = @{GV_COMPANY_CD}
		          AND DGP.BU_CD = @{GV_BU_CD}
		          AND DGP.PLANT_CD = 'WF01'
		          AND DGP.GR_DATE <![CDATA[>=]]> @P_W3_REQ_SUN
            	  AND DGP.GR_DATE <![CDATA[<=]]> CASE MIP.CLEANING_FLAG WHEN 'Y' THEN @P_W3_REQ_TUE WHEN 'N' THEN @P_W3_REQ_THU END
		          AND EXISTS (
								SELECT 1
		                        FROM TB_MST_ITEM_PLANT MIP WITH(NOLOCK)
		                        WHERE MIP.COMPANY_CD = DGP.COMPANY_CD
		                          AND MIP.BU_CD = DGP.BU_CD
		                          AND MIP.PLANT_CD = DGP.PLANT_CD
		                          AND MIP.ITEM_CD = DGP.ITEM_CD
		                          AND MIP.ITEM_TYPE = '20'
		                          AND MIP.PROCUR_TYPE IN ('MG', 'MH')
		                     )		    

				UNION ALL
				SELECT ISP.COMPANY_CD
			         , ISP.BU_CD
			         , ISP.ITEM_CD
			         , ISP.LOT_SIZE
			         , ISP.INSP_QTY
			         , ISP.GOODS_QTY
			         , ISP.DEFECT_QTY
			         , (ISP.GOODS_QTY - ISP.SPEC_QTY) AS CMPL_QTY
			         , ISP.SPEC_QTY
			         , NULL AS ADJ_INSP_REQ_DATE
			         , ISP.RELEASE_DATE
			         , NULL YEARWEEK
			         , NULL QTY
			         , 'W_4_ETC' FLAG
			    FROM TB_DYN_INSPECTION ISP WITH (NOLOCK)
				INNER JOIN TB_MST_ITEM_PLANT MIP WITH(NOLOCK)
            	   ON MIP.COMPANY_CD = ISP.COMPANY_CD
           		  AND MIP.BU_CD = ISP.BU_CD
           		  AND MIP.PLANT_CD = ISP.PLANT_CD
           		  AND MIP.ITEM_CD = ISP.ITEM_CD
			    WHERE ISP.COMPANY_CD = @{GV_COMPANY_CD}
			      AND ISP.BU_CD      = @{GV_BU_CD} 
			      AND ISP.PLANT_CD   = 'WF01'
			      AND ISP.DEL_FLAG   = 'N'
				  AND ISP.RELEASE_DATE <![CDATA[>=]]> @P_W4_REQ_SUN
            	  AND ISP.RELEASE_DATE <![CDATA[<=]]> CASE MIP.CLEANING_FLAG WHEN 'Y' THEN @P_W4_REQ_TUE WHEN 'N' THEN @P_W4_REQ_THU END
				UNION ALL
          		SELECT DGP.COMPANY_CD
					 , DGP.BU_CD
		             , DGP.ITEM_CD
		             , DGP.GR_QTY AS LOT_SIZE
		             , DGP.GR_QTY AS INSP_QTY
		             , DGP.GR_QTY AS GOODS_QTY
		             , NULL AS DEFECT_QTY
		             , DGP.GR_QTY AS CMPL_QTY
		             , NULL AS SPEC_QTY
		             , NULL AS ADJ_INSP_REQ_DATE
		             , DGP.GR_DATE AS RELEASE_DATE
		             , NULL YEARWEEK
		             , NULL QTY
		             , 'W_4_ETC' FLAG
				FROM TB_DYN_GR_PROD DGP WITH(NOLOCK)
				INNER JOIN TB_MST_ITEM_PLANT MIP WITH(NOLOCK)
            	   ON MIP.COMPANY_CD = DGP.COMPANY_CD
           		  AND MIP.BU_CD = DGP.BU_CD
           		  AND MIP.PLANT_CD = DGP.PLANT_CD
           		  AND MIP.ITEM_CD = DGP.ITEM_CD
		        WHERE DGP.COMPANY_CD = @{GV_COMPANY_CD}
		          AND DGP.BU_CD = @{GV_BU_CD}
		          AND DGP.PLANT_CD = 'WF01'
		          AND DGP.GR_DATE <![CDATA[>=]]> @P_W4_REQ_SUN
            	  AND DGP.GR_DATE <![CDATA[<=]]> CASE MIP.CLEANING_FLAG WHEN 'Y' THEN @P_W4_REQ_TUE WHEN 'N' THEN @P_W4_REQ_THU END
		          AND EXISTS (
								SELECT 1
		                        FROM TB_MST_ITEM_PLANT MIP WITH(NOLOCK)
		                        WHERE MIP.COMPANY_CD = DGP.COMPANY_CD
		                          AND MIP.BU_CD = DGP.BU_CD
		                          AND MIP.PLANT_CD = DGP.PLANT_CD
		                          AND MIP.ITEM_CD = DGP.ITEM_CD
		                          AND MIP.ITEM_TYPE = '20'
		                          AND MIP.PROCUR_TYPE IN ('MG', 'MH')
		                     )		    
				UNION ALL
				SELECT ISP.COMPANY_CD
			         , ISP.BU_CD
			         , ISP.ITEM_CD
			         , ISP.LOT_SIZE
			         , ISP.INSP_QTY
			         , ISP.GOODS_QTY
			         , ISP.DEFECT_QTY
			         , (ISP.GOODS_QTY - ISP.SPEC_QTY) AS CMPL_QTY
			         , ISP.SPEC_QTY
			         , NULL AS ADJ_INSP_REQ_DATE
			         , ISP.RELEASE_DATE
			         , NULL YEARWEEK
			         , NULL QTY
			         , 'W_5_ETC' FLAG
			    FROM TB_DYN_INSPECTION ISP WITH (NOLOCK)
				INNER JOIN TB_MST_ITEM_PLANT MIP WITH(NOLOCK)
            	   ON MIP.COMPANY_CD = ISP.COMPANY_CD
           		  AND MIP.BU_CD = ISP.BU_CD
           		  AND MIP.PLANT_CD = ISP.PLANT_CD
           		  AND MIP.ITEM_CD = ISP.ITEM_CD
			    WHERE ISP.COMPANY_CD = @{GV_COMPANY_CD}
			      AND ISP.BU_CD      = @{GV_BU_CD} 
			      AND ISP.PLANT_CD   = 'WF01'
			      AND ISP.DEL_FLAG   = 'N'
				  AND ISP.RELEASE_DATE <![CDATA[>=]]> @P_W5_REQ_SUN
            	  AND ISP.RELEASE_DATE <![CDATA[<=]]> CASE MIP.CLEANING_FLAG WHEN 'Y' THEN @P_W5_REQ_TUE WHEN 'N' THEN @P_W5_REQ_THU END
				UNION ALL
          		SELECT DGP.COMPANY_CD
					 , DGP.BU_CD
		             , DGP.ITEM_CD
		             , DGP.GR_QTY AS LOT_SIZE
		             , DGP.GR_QTY AS INSP_QTY
		             , DGP.GR_QTY AS GOODS_QTY
		             , NULL AS DEFECT_QTY
		             , DGP.GR_QTY AS CMPL_QTY
		             , NULL AS SPEC_QTY
		             , NULL AS ADJ_INSP_REQ_DATE
		             , DGP.GR_DATE AS RELEASE_DATE
		             , NULL YEARWEEK
		             , NULL QTY
		             , 'W_5_ETC' FLAG
				FROM TB_DYN_GR_PROD DGP WITH(NOLOCK)
				INNER JOIN TB_MST_ITEM_PLANT MIP WITH(NOLOCK)
            	   ON MIP.COMPANY_CD = DGP.COMPANY_CD
           		  AND MIP.BU_CD = DGP.BU_CD
           		  AND MIP.PLANT_CD = DGP.PLANT_CD
           		  AND MIP.ITEM_CD = DGP.ITEM_CD
		        WHERE DGP.COMPANY_CD = @{GV_COMPANY_CD}
		          AND DGP.BU_CD = @{GV_BU_CD}
		          AND DGP.PLANT_CD = 'WF01'
		          AND DGP.GR_DATE <![CDATA[>=]]> @P_W5_REQ_SUN
            	  AND DGP.GR_DATE <![CDATA[<=]]> CASE MIP.CLEANING_FLAG WHEN 'Y' THEN @P_W5_REQ_TUE WHEN 'N' THEN @P_W5_REQ_THU END
		          AND EXISTS (
								SELECT 1
		                        FROM TB_MST_ITEM_PLANT MIP WITH(NOLOCK)
		                        WHERE MIP.COMPANY_CD = DGP.COMPANY_CD
		                          AND MIP.BU_CD = DGP.BU_CD
		                          AND MIP.PLANT_CD = DGP.PLANT_CD
		                          AND MIP.ITEM_CD = DGP.ITEM_CD
		                          AND MIP.ITEM_TYPE = '20'
		                          AND MIP.PROCUR_TYPE IN ('MG', 'MH')
		                     )		    

				/*계획 수량*/
				UNION ALL
          		SELECT KAPPW.COMPANY_CD
	                 , KAPPW.BU_CD
	                 , KAPPW.ITEM_CD
	                 , NULL
	                 , NULL
	                 , NULL
	                 , NULL
	                 , NULL
	                 , NULL
	                 , NULL
	                 , NULL
	                 , NULL
	                 , KAPPW.QTY
	                 , 'W_0' AS FLAG
				FROM TB_KPI_APS_PROD_PLAN_WEEKLY KAPPW WITH(NOLOCK)
				INNER JOIN TB_MST_ITEM_PLANT MIP WITH(NOLOCK)
            	   ON MIP.COMPANY_CD = KAPPW.COMPANY_CD
           		  AND MIP.BU_CD = KAPPW.BU_CD
           		  AND MIP.PLANT_CD = 'WF01'
           		  AND MIP.ITEM_CD = KAPPW.ITEM_CD
				WHERE KAPPW.COMPANY_CD = @{GV_COMPANY_CD}
	              AND KAPPW.BU_CD = @{GV_BU_CD}
	              AND MIP.PLANT_CD = 'WF01'
	              AND KAPPW.YYYYMMDD <![CDATA[>=]]> @P_W0_REQ_SUN
            	  AND KAPPW.YYYYMMDD <![CDATA[<=]]> CASE MIP.CLEANING_FLAG WHEN 'Y' THEN @P_W0_REQ_TUE WHEN 'N' THEN @P_W0_REQ_THU END
	          	UNION ALL
	          	SELECT PP.COMPANY_CD
			         , PP.BU_CD
			         , PP.ITEM_CD
			         , NULL
			         , NULL
			         , NULL
			         , NULL
			         , NULL
			         , NULL
			         , NULL
			         , NULL
			         , NULL
			         , PP.QTY
			         , 'W_0' AS FLAG
	          	FROM TB_HIS_APS_PROD_PLAN_DAILY PP WITH(NOLOCK)
				WHERE PP.COMPANY_CD = @{GV_COMPANY_CD}
			      AND PP.BU_CD      = @{GV_BU_CD} 
			      AND PP.PLAN_ID    = @P_W1_REQ_THU
	         	  AND PP.YYYYMMDD BETWEEN @P_W1_REQ_FRI AND @P_W1_REQ_SAT
              
				UNION ALL
          		SELECT KAPPW.COMPANY_CD
	                 , KAPPW.BU_CD
	                 , KAPPW.ITEM_CD
	                 , NULL
	                 , NULL
	                 , NULL
	                 , NULL
	                 , NULL
	                 , NULL
	                 , NULL
	                 , NULL
	                 , NULL
	                 , KAPPW.QTY
	                 , 'W_1' AS FLAG
				FROM TB_KPI_APS_PROD_PLAN_WEEKLY KAPPW WITH(NOLOCK)
				INNER JOIN TB_MST_ITEM_PLANT MIP WITH(NOLOCK)
            	   ON MIP.COMPANY_CD = KAPPW.COMPANY_CD
           		  AND MIP.BU_CD = KAPPW.BU_CD
           		  AND MIP.PLANT_CD = 'WF01'
           		  AND MIP.ITEM_CD = KAPPW.ITEM_CD
				WHERE KAPPW.COMPANY_CD = @{GV_COMPANY_CD}
	              AND KAPPW.BU_CD = @{GV_BU_CD}
	              AND MIP.PLANT_CD = 'WF01'
	              AND KAPPW.YYYYMMDD <![CDATA[>=]]> @P_W1_REQ_SUN
            	  AND KAPPW.YYYYMMDD <![CDATA[<=]]> CASE MIP.CLEANING_FLAG WHEN 'Y' THEN @P_W1_REQ_TUE WHEN 'N' THEN @P_W1_REQ_THU END
	          	UNION ALL
	          	SELECT PP.COMPANY_CD
			         , PP.BU_CD
			         , PP.ITEM_CD
			         , NULL
			         , NULL
			         , NULL
			         , NULL
			         , NULL
			         , NULL
			         , NULL
			         , NULL
			         , NULL
			         , PP.QTY
			         , 'W_1' AS FLAG
	          	FROM TB_HIS_APS_PROD_PLAN_DAILY PP WITH(NOLOCK)
				WHERE PP.COMPANY_CD = @{GV_COMPANY_CD}
			      AND PP.BU_CD      = @{GV_BU_CD} 
			      AND PP.PLAN_ID    = @P_W2_REQ_THU
	         	  AND PP.YYYYMMDD BETWEEN @P_W2_REQ_FRI AND @P_W2_REQ_SAT
				
				UNION ALL
          		SELECT KAPPW.COMPANY_CD
	                 , KAPPW.BU_CD
	                 , KAPPW.ITEM_CD
	                 , NULL
	                 , NULL
	                 , NULL
	                 , NULL
	                 , NULL
	                 , NULL
	                 , NULL
	                 , NULL
	                 , NULL
	                 , KAPPW.QTY
	                 , 'W_2' AS FLAG
				FROM TB_KPI_APS_PROD_PLAN_WEEKLY KAPPW WITH(NOLOCK)
				INNER JOIN TB_MST_ITEM_PLANT MIP WITH(NOLOCK)
            	   ON MIP.COMPANY_CD = KAPPW.COMPANY_CD
           		  AND MIP.BU_CD = KAPPW.BU_CD
           		  AND MIP.PLANT_CD = 'WF01'
           		  AND MIP.ITEM_CD = KAPPW.ITEM_CD
				WHERE KAPPW.COMPANY_CD = @{GV_COMPANY_CD}
	              AND KAPPW.BU_CD = @{GV_BU_CD}
	              AND MIP.PLANT_CD = 'WF01'
	              AND KAPPW.YYYYMMDD <![CDATA[>=]]> @P_W2_REQ_SUN
            	  AND KAPPW.YYYYMMDD <![CDATA[<=]]> CASE MIP.CLEANING_FLAG WHEN 'Y' THEN @P_W2_REQ_TUE WHEN 'N' THEN @P_W2_REQ_THU END
	          	UNION ALL
	          	SELECT PP.COMPANY_CD
			         , PP.BU_CD
			         , PP.ITEM_CD
			         , NULL
			         , NULL
			         , NULL
			         , NULL
			         , NULL
			         , NULL
			         , NULL
			         , NULL
			         , NULL
			         , PP.QTY
			         , 'W_2' AS FLAG
	          	FROM TB_HIS_APS_PROD_PLAN_DAILY PP WITH(NOLOCK)
				WHERE PP.COMPANY_CD = @{GV_COMPANY_CD}
			      AND PP.BU_CD      = @{GV_BU_CD} 
			      AND PP.PLAN_ID    = @P_W3_REQ_THU
	         	  AND PP.YYYYMMDD BETWEEN @P_W3_REQ_FRI AND @P_W3_REQ_SAT

				UNION ALL
          		SELECT KAPPW.COMPANY_CD
	                 , KAPPW.BU_CD
	                 , KAPPW.ITEM_CD
	                 , NULL
	                 , NULL
	                 , NULL
	                 , NULL
	                 , NULL
	                 , NULL
	                 , NULL
	                 , NULL
	                 , NULL
	                 , KAPPW.QTY
	                 , 'W_3' AS FLAG
				FROM TB_KPI_APS_PROD_PLAN_WEEKLY KAPPW WITH(NOLOCK)
				INNER JOIN TB_MST_ITEM_PLANT MIP WITH(NOLOCK)
            	   ON MIP.COMPANY_CD = KAPPW.COMPANY_CD
           		  AND MIP.BU_CD = KAPPW.BU_CD
           		  AND MIP.PLANT_CD = 'WF01'
           		  AND MIP.ITEM_CD = KAPPW.ITEM_CD
				WHERE KAPPW.COMPANY_CD = @{GV_COMPANY_CD}
	              AND KAPPW.BU_CD = @{GV_BU_CD}
	              AND MIP.PLANT_CD = 'WF01'
	              AND KAPPW.YYYYMMDD <![CDATA[>=]]> @P_W3_REQ_SUN
            	  AND KAPPW.YYYYMMDD <![CDATA[<=]]> CASE MIP.CLEANING_FLAG WHEN 'Y' THEN @P_W3_REQ_TUE WHEN 'N' THEN @P_W3_REQ_THU END
	          	UNION ALL
	          	SELECT PP.COMPANY_CD
			         , PP.BU_CD
			         , PP.ITEM_CD
			         , NULL
			         , NULL
			         , NULL
			         , NULL
			         , NULL
			         , NULL
			         , NULL
			         , NULL
			         , NULL
			         , PP.QTY
			         , 'W_3' AS FLAG
	          	FROM TB_HIS_APS_PROD_PLAN_DAILY PP WITH(NOLOCK)
				WHERE PP.COMPANY_CD = @{GV_COMPANY_CD}
			      AND PP.BU_CD      = @{GV_BU_CD} 
			      AND PP.PLAN_ID    = @P_W4_REQ_THU
	         	  AND PP.YYYYMMDD BETWEEN @P_W4_REQ_FRI AND @P_W4_REQ_SAT
	         	  
				UNION ALL
          		SELECT KAPPW.COMPANY_CD
	                 , KAPPW.BU_CD
	                 , KAPPW.ITEM_CD
	                 , NULL
	                 , NULL
	                 , NULL
	                 , NULL
	                 , NULL
	                 , NULL
	                 , NULL
	                 , NULL
	                 , NULL
	                 , KAPPW.QTY
	                 , 'W_4' AS FLAG
				FROM TB_KPI_APS_PROD_PLAN_WEEKLY KAPPW WITH(NOLOCK)
				INNER JOIN TB_MST_ITEM_PLANT MIP WITH(NOLOCK)
            	   ON MIP.COMPANY_CD = KAPPW.COMPANY_CD
           		  AND MIP.BU_CD = KAPPW.BU_CD
           		  AND MIP.PLANT_CD = 'WF01'
           		  AND MIP.ITEM_CD = KAPPW.ITEM_CD
				WHERE KAPPW.COMPANY_CD = @{GV_COMPANY_CD}
	              AND KAPPW.BU_CD = @{GV_BU_CD}
	              AND MIP.PLANT_CD = 'WF01'
	              AND KAPPW.YYYYMMDD <![CDATA[>=]]> @P_W4_REQ_SUN
            	  AND KAPPW.YYYYMMDD <![CDATA[<=]]> CASE MIP.CLEANING_FLAG WHEN 'Y' THEN @P_W4_REQ_TUE WHEN 'N' THEN @P_W4_REQ_THU END
	          	UNION ALL
	          	SELECT PP.COMPANY_CD
			         , PP.BU_CD
			         , PP.ITEM_CD
			         , NULL
			         , NULL
			         , NULL
			         , NULL
			         , NULL
			         , NULL
			         , NULL
			         , NULL
			         , NULL
			         , PP.QTY
			         , 'W_4' AS FLAG
	          	FROM TB_HIS_APS_PROD_PLAN_DAILY PP WITH(NOLOCK)
				WHERE PP.COMPANY_CD = @{GV_COMPANY_CD}
			      AND PP.BU_CD      = @{GV_BU_CD} 
			      AND PP.PLAN_ID    = @P_W5_REQ_THU
	         	  AND PP.YYYYMMDD BETWEEN @P_W5_REQ_FRI AND @P_W5_REQ_SAT
				
				/*선행생산 계획*/
	          	UNION ALL
	          	SELECT PP.COMPANY_CD
			         , PP.BU_CD
			         , PP.ITEM_CD
			         , NULL
			         , NULL
			         , NULL
			         , NULL
			         , NULL
			         , NULL
			         , NULL
			         , NULL
			         , NULL
			         , PP.QTY
			         , 'W_1_PLAN' AS FLAG
	          	FROM TB_HIS_APS_PROD_PLAN_DAILY PP WITH(NOLOCK)
				WHERE PP.COMPANY_CD = @{GV_COMPANY_CD}
			      AND PP.BU_CD      = @{GV_BU_CD} 
			      AND PP.PLAN_ID = @P_W1_REQ_THU
	         	  AND PP.YYYYMMDD = @P_W1_REQ_THU
	         	UNION ALL
	          	SELECT PP.COMPANY_CD
			         , PP.BU_CD
			         , PP.ITEM_CD
			         , NULL
			         , NULL
			         , NULL
			         , NULL
			         , NULL
			         , NULL
			         , NULL
			         , NULL
			         , NULL
			         , PP.QTY
			         , 'W_2_PLAN' AS FLAG
	          	FROM TB_HIS_APS_PROD_PLAN_DAILY PP WITH(NOLOCK)
				WHERE PP.COMPANY_CD = @{GV_COMPANY_CD}
			      AND PP.BU_CD      = @{GV_BU_CD} 
			      AND PP.PLAN_ID = @P_W2_REQ_THU
	         	  AND PP.YYYYMMDD = @P_W2_REQ_THU
	         	UNION ALL
	          	SELECT PP.COMPANY_CD
			         , PP.BU_CD
			         , PP.ITEM_CD
			         , NULL
			         , NULL
			         , NULL
			         , NULL
			         , NULL
			         , NULL
			         , NULL
			         , NULL
			         , NULL
			         , PP.QTY
			         , 'W_3_PLAN' AS FLAG
	          	FROM TB_HIS_APS_PROD_PLAN_DAILY PP WITH(NOLOCK)
				WHERE PP.COMPANY_CD = @{GV_COMPANY_CD}
			      AND PP.BU_CD      = @{GV_BU_CD} 
			      AND PP.PLAN_ID = @P_W3_REQ_THU
	         	  AND PP.YYYYMMDD = @P_W3_REQ_THU
	         	UNION ALL
	          	SELECT PP.COMPANY_CD
			         , PP.BU_CD
			         , PP.ITEM_CD
			         , NULL
			         , NULL
			         , NULL
			         , NULL
			         , NULL
			         , NULL
			         , NULL
			         , NULL
			         , NULL
			         , PP.QTY
			         , 'W_4_PLAN' AS FLAG
	          	FROM TB_HIS_APS_PROD_PLAN_DAILY PP WITH(NOLOCK)
				WHERE PP.COMPANY_CD = @{GV_COMPANY_CD}
			      AND PP.BU_CD      = @{GV_BU_CD} 
			      AND PP.PLAN_ID = @P_W4_REQ_THU
	         	  AND PP.YYYYMMDD = @P_W4_REQ_THU
	         	UNION ALL
	          	SELECT PP.COMPANY_CD
			         , PP.BU_CD
			         , PP.ITEM_CD
			         , NULL
			         , NULL
			         , NULL
			         , NULL
			         , NULL
			         , NULL
			         , NULL
			         , NULL
			         , NULL
			         , PP.QTY
			         , 'W_5_PLAN' AS FLAG
	          	FROM TB_HIS_APS_PROD_PLAN_DAILY PP WITH(NOLOCK)
				WHERE PP.COMPANY_CD = @{GV_COMPANY_CD}
			      AND PP.BU_CD      = @{GV_BU_CD} 
			      AND PP.PLAN_ID = @P_W5_REQ_THU
	         	  AND PP.YYYYMMDD = @P_W5_REQ_THU
	         	
#end
	         	
	         	
	         	/*선행생산 실적 */
	          	UNION ALL
				SELECT ISP.COMPANY_CD
				     , ISP.BU_CD
				     , ISP.ITEM_CD
				     , NULL
				     , NULL
				     , NULL
				     , NULL
				     , ISP.GOODS_QTY AS CMPL_QTY
				     , NULL
				     , NULL
				     , ISP.RELEASE_DATE
				     , NULL YEARWEEK
				     , NULL QTY
				     , 'W_1_PERFORM' FLAG
				FROM TB_DYN_INSPECTION ISP WITH (NOLOCK)
				WHERE ISP.COMPANY_CD = @{GV_COMPANY_CD}
			  	  AND ISP.BU_CD      = @{GV_BU_CD} 
			  	  AND ISP.PLANT_CD   = 'WF01'
			  	  AND DEL_FLAG       = 'N'
			  	  AND RELEASE_DATE BETWEEN @P_W1_REQ_THU AND @P_W1_REQ_SAT
				UNION ALL
          		SELECT DGP.COMPANY_CD
	                 , DGP.BU_CD
	                 , DGP.ITEM_CD
	                 , NULL
	                 , NULL
	                 , NULL
	                 , NULL
	                 , DGP.GR_QTY AS CMPL_QTY
	                 , NULL
	                 , NULL
	                 , DGP.GR_DATE AS RELEASE_DATE
	                 , NULL YEARWEEK
	                 , NULL QTY
	                 , 'W_1_PERFORM' FLAG
				FROM TB_DYN_GR_PROD DGP WITH(NOLOCK)
	           	WHERE DGP.COMPANY_CD = @{GV_COMPANY_CD}
	              AND DGP.BU_CD = @{GV_BU_CD} 
	              AND DGP.PLANT_CD = 'WF01'
	              AND DGP.GR_DATE BETWEEN @P_W1_REQ_THU AND @P_W1_REQ_SAT
	              AND EXISTS (
                         		SELECT 1
                           		FROM TB_MST_ITEM_PLANT MIP WITH(NOLOCK)
                          		WHERE MIP.COMPANY_CD = DGP.COMPANY_CD
	                              AND MIP.BU_CD = DGP.BU_CD
	                              AND MIP.PLANT_CD = DGP.PLANT_CD
	                              AND MIP.ITEM_CD = DGP.ITEM_CD
	                              AND MIP.ITEM_TYPE = '20'
	                              AND MIP.PROCUR_TYPE IN ('MG', 'MH')
                        	 )
			  	UNION ALL
				SELECT ISP.COMPANY_CD
				     , ISP.BU_CD
				     , ISP.ITEM_CD
				     , NULL
				     , NULL
				     , NULL
				     , NULL
				     , ISP.GOODS_QTY AS CMPL_QTY
				     , NULL
				     , NULL
				     , ISP.RELEASE_DATE
				     , NULL YEARWEEK
				     , NULL QTY
				     , 'W_2_PERFORM' FLAG
				FROM TB_DYN_INSPECTION ISP WITH (NOLOCK)
				WHERE ISP.COMPANY_CD = @{GV_COMPANY_CD}
			  	  AND ISP.BU_CD      = @{GV_BU_CD} 
			  	  AND ISP.PLANT_CD   = 'WF01'
			  	  AND DEL_FLAG       = 'N'
			  	  AND RELEASE_DATE BETWEEN @P_W2_REQ_THU AND @P_W2_REQ_SAT
				UNION ALL
          		SELECT DGP.COMPANY_CD
	                 , DGP.BU_CD
	                 , DGP.ITEM_CD
	                 , NULL
	                 , NULL
	                 , NULL
	                 , NULL
	                 , DGP.GR_QTY AS CMPL_QTY
	                 , NULL
	                 , NULL
	                 , DGP.GR_DATE AS RELEASE_DATE
	                 , NULL YEARWEEK
	                 , NULL QTY
	                 , 'W_2_PERFORM' FLAG
				FROM TB_DYN_GR_PROD DGP WITH(NOLOCK)
	           	WHERE DGP.COMPANY_CD = @{GV_COMPANY_CD}
	              AND DGP.BU_CD = @{GV_BU_CD} 
	              AND DGP.PLANT_CD = 'WF01'
	              AND DGP.GR_DATE BETWEEN @P_W2_REQ_THU AND @P_W2_REQ_SAT
	              AND EXISTS (
                         		SELECT 1
                           		FROM TB_MST_ITEM_PLANT MIP WITH(NOLOCK)
                          		WHERE MIP.COMPANY_CD = DGP.COMPANY_CD
	                              AND MIP.BU_CD = DGP.BU_CD
	                              AND MIP.PLANT_CD = DGP.PLANT_CD
	                              AND MIP.ITEM_CD = DGP.ITEM_CD
	                              AND MIP.ITEM_TYPE = '20'
	                              AND MIP.PROCUR_TYPE IN ('MG', 'MH')
                        	 )
			  	UNION ALL
				SELECT ISP.COMPANY_CD
				     , ISP.BU_CD
				     , ISP.ITEM_CD
				     , NULL
				     , NULL
				     , NULL
				     , NULL
				     , ISP.GOODS_QTY AS CMPL_QTY
				     , NULL
				     , NULL
				     , ISP.RELEASE_DATE
				     , NULL YEARWEEK
				     , NULL QTY
				     , 'W_3_PERFORM' FLAG
				FROM TB_DYN_INSPECTION ISP WITH (NOLOCK)
				WHERE ISP.COMPANY_CD = @{GV_COMPANY_CD}
			  	  AND ISP.BU_CD      = @{GV_BU_CD} 
			  	  AND ISP.PLANT_CD   = 'WF01'
			  	  AND DEL_FLAG       = 'N'
			  	  AND RELEASE_DATE BETWEEN @P_W3_REQ_THU AND @P_W3_REQ_SAT
			  	UNION ALL
          		SELECT DGP.COMPANY_CD
	                 , DGP.BU_CD
	                 , DGP.ITEM_CD
	                 , NULL
	                 , NULL
	                 , NULL
	                 , NULL
	                 , DGP.GR_QTY AS CMPL_QTY
	                 , NULL
	                 , NULL
	                 , DGP.GR_DATE AS RELEASE_DATE
	                 , NULL YEARWEEK
	                 , NULL QTY
	                 , 'W_3_PERFORM' FLAG
				FROM TB_DYN_GR_PROD DGP WITH(NOLOCK)
	           	WHERE DGP.COMPANY_CD = @{GV_COMPANY_CD}
	              AND DGP.BU_CD = @{GV_BU_CD} 
	              AND DGP.PLANT_CD = 'WF01'
	              AND DGP.GR_DATE BETWEEN @P_W3_REQ_THU AND @P_W3_REQ_SAT
	              AND EXISTS (
                         		SELECT 1
                           		FROM TB_MST_ITEM_PLANT MIP WITH(NOLOCK)
                          		WHERE MIP.COMPANY_CD = DGP.COMPANY_CD
	                              AND MIP.BU_CD = DGP.BU_CD
	                              AND MIP.PLANT_CD = DGP.PLANT_CD
	                              AND MIP.ITEM_CD = DGP.ITEM_CD
	                              AND MIP.ITEM_TYPE = '20'
	                              AND MIP.PROCUR_TYPE IN ('MG', 'MH')
                        	 )
			  	UNION ALL
				SELECT ISP.COMPANY_CD
				     , ISP.BU_CD
				     , ISP.ITEM_CD
				     , NULL
				     , NULL
				     , NULL
				     , NULL
				     , ISP.GOODS_QTY AS CMPL_QTY
				     , NULL
				     , NULL
				     , ISP.RELEASE_DATE
				     , NULL YEARWEEK
				     , NULL QTY
				     , 'W_4_PERFORM' FLAG
				FROM TB_DYN_INSPECTION ISP WITH (NOLOCK)
				WHERE ISP.COMPANY_CD = @{GV_COMPANY_CD}
			  	  AND ISP.BU_CD      = @{GV_BU_CD} 
			  	  AND ISP.PLANT_CD   = 'WF01'
			  	  AND DEL_FLAG       = 'N'
			  	  AND RELEASE_DATE BETWEEN @P_W4_REQ_THU AND @P_W4_REQ_SAT
			  	UNION ALL
          		SELECT DGP.COMPANY_CD
	                 , DGP.BU_CD
	                 , DGP.ITEM_CD
	                 , NULL
	                 , NULL
	                 , NULL
	                 , NULL
	                 , DGP.GR_QTY AS CMPL_QTY
	                 , NULL
	                 , NULL
	                 , DGP.GR_DATE AS RELEASE_DATE
	                 , NULL YEARWEEK
	                 , NULL QTY
	                 , 'W_4_PERFORM' FLAG
				FROM TB_DYN_GR_PROD DGP WITH(NOLOCK)
	           	WHERE DGP.COMPANY_CD = @{GV_COMPANY_CD}
	              AND DGP.BU_CD = @{GV_BU_CD} 
	              AND DGP.PLANT_CD = 'WF01'
	              AND DGP.GR_DATE BETWEEN @P_W4_REQ_THU AND @P_W4_REQ_SAT
	              AND EXISTS (
                         		SELECT 1
                           		FROM TB_MST_ITEM_PLANT MIP WITH(NOLOCK)
                          		WHERE MIP.COMPANY_CD = DGP.COMPANY_CD
	                              AND MIP.BU_CD = DGP.BU_CD
	                              AND MIP.PLANT_CD = DGP.PLANT_CD
	                              AND MIP.ITEM_CD = DGP.ITEM_CD
	                              AND MIP.ITEM_TYPE = '20'
	                              AND MIP.PROCUR_TYPE IN ('MG', 'MH')
                        	 )
			  	UNION ALL
				SELECT ISP.COMPANY_CD
				     , ISP.BU_CD
				     , ISP.ITEM_CD
				     , NULL
				     , NULL
				     , NULL
				     , NULL
				     , ISP.GOODS_QTY AS CMPL_QTY
				     , NULL
				     , NULL
				     , ISP.RELEASE_DATE
				     , NULL YEARWEEK
				     , NULL QTY
				     , 'W_5_PERFORM' FLAG
				FROM TB_DYN_INSPECTION ISP WITH (NOLOCK)
				WHERE ISP.COMPANY_CD = @{GV_COMPANY_CD}
			  	  AND ISP.BU_CD      = @{GV_BU_CD} 
			  	  AND ISP.PLANT_CD   = 'WF01'
			  	  AND DEL_FLAG       = 'N'
			  	  AND RELEASE_DATE BETWEEN @P_W5_REQ_THU AND @P_W5_REQ_SAT
				UNION ALL
          		SELECT DGP.COMPANY_CD
	                 , DGP.BU_CD
	                 , DGP.ITEM_CD
	                 , NULL
	                 , NULL
	                 , NULL
	                 , NULL
	                 , DGP.GR_QTY AS CMPL_QTY
	                 , NULL
	                 , NULL
	                 , DGP.GR_DATE AS RELEASE_DATE
	                 , NULL YEARWEEK
	                 , NULL QTY
	                 , 'W_5_PERFORM' FLAG
				FROM TB_DYN_GR_PROD DGP WITH(NOLOCK)
	           	WHERE DGP.COMPANY_CD = @{GV_COMPANY_CD}
	              AND DGP.BU_CD = @{GV_BU_CD} 
	              AND DGP.PLANT_CD = 'WF01'
	              AND DGP.GR_DATE BETWEEN @P_W5_REQ_THU AND @P_W5_REQ_SAT
	              AND EXISTS (
                         		SELECT 1
                           		FROM TB_MST_ITEM_PLANT MIP WITH(NOLOCK)
                          		WHERE MIP.COMPANY_CD = DGP.COMPANY_CD
	                              AND MIP.BU_CD = DGP.BU_CD
	                              AND MIP.PLANT_CD = DGP.PLANT_CD
	                              AND MIP.ITEM_CD = DGP.ITEM_CD
	                              AND MIP.ITEM_TYPE = '20'
	                              AND MIP.PROCUR_TYPE IN ('MG', 'MH')
                        	 )  
				/* FQC_DATA */	         	
	         	UNION ALL
	         	SELECT DWR.COMPANY_CD
				     , DWR.BU_CD
				     , DPOH.ITEM_CD
				     , NULL
			         , NULL
			         , NULL
			         , NULL
			         , NULL
			         , NULL
			         , NULL
			         , NULL
			         , NULL
			         , DWR.REMAIN_QTY AS QTY
			         , 'FQC_DATA' AS FLAG
				FROM TB_DYN_WIP_ROUTING DWR WITH(NOLOCK)
				INNER JOIN TB_DYN_PROD_ORDER_HDR DPOH WITH(NOLOCK)
				   ON DPOH.COMPANY_CD = DWR.COMPANY_CD
				  AND DPOH.BU_CD = DWR.BU_CD
				  AND DPOH.PROD_ORDER_NO = DWR.PROD_ORDER_NO
				WHERE DWR.COMPANY_CD = @{GV_COMPANY_CD}
			      AND DWR.BU_CD      = @{GV_BU_CD} 
			      AND DWR.WIP_DATE   = @FQC_DATE
			      AND DWR.PROD_OR_QC = 'QC_PART'
			)
			
			
			
		    SELECT NULL AS TMP_COL
			    <include refid="include.getCdDimTotal"/>
			    <include refid="include.getGrpLvlId"/>
			     , SUM(FQC_DATA)      AS FQC_DATA                     -- FQC DATA
		         , SUM(W0_PL_CNT)     AS W0_PL_CNT                    -- 계획건수
		         
		         , SUM(W0_PL_QTY)     AS W0_PL_QTY                    -- 계획수량
		         , SUM(W0_GOODS_QTY)  AS W0_GOODS_QTY                 -- 합격 + 특채
		         , SUM(W0_DEFECT_QTY) AS W0_DEFECT_QTY                -- 불량수
		         , SUM(W0_CMPL_QTY)   AS W0_CMPL_QTY                  -- 합격수량
		         , SUM(W0_SPEC_QTY)   AS W0_SPEC_QTY                  -- 특채수량
		         , SUM(W1_PREPRODUCTION_QTY) AS W1_PREPRODUCTION_QTY  -- W-1 선행생산
		        #foreach( $i in $weekArr2 )
				#set($j = $i - 1)
		         , CASE WHEN ISNULL(SUM(W${j}_PL_QTY), 0) = 0 AND ISNULL(SUM(W${j}_GOODS_QTY), 0) <![CDATA[>]]> 0 THEN NULL 
		                ELSE (ISNULL(SUM(W${j}_GOODS_QTY), 0) + ISNULL(SUM(W${i}_PREPRODUCTION_QTY), 0)) / NULLIF(SUM(W${j}_PL_QTY), 0) * 100
		            END W${j}_ACIV_RATE
		         , ROUND(CAST(ISNULL(SUM (OB${j}_CNT), 0) AS NUMERIC) / CAST(NULLIF((ISNULL(SUM (OB${j}_CNT), 0) + ISNULL(SUM (UN${j}_CNT), 0)), 0) AS NUMERIC) * 100.0, 0) AS CMPL${j}_RATE
				#end
				
				
				
				#set($grpLvlId = "")
				#set($rollupDot = ".")
				#if(!$rollupAlias or $rollupAlias == "")
				#set($rollupAlias = "")
				#set($rollupDot = "")
				#end
				#foreach( $dimMap in $_parameter.dimList )
				#if($foreach.count == 1)
				#set($grpLvlId = ${rollupAlias} + ${rollupDot} + ${dimMap.DIM_CD})
				#else
				#set($grpLvlId = ${grpLvlId} + ", " + ${rollupAlias} + ${rollupDot} + ${dimMap.DIM_CD})
				#end
				#end
         
                --210608 김수호 추가 
                ------------------------------------------------------------
				#foreach( $i in $weekArr2 )
                #set($j = $i - 1)
					
				 , CASE WHEN GROUPING_ID(${grpLvlId}) = 0 THEN
				      SUM(W${j}_ACIV_RATE2)
				   ELSE
				      AVG(W${j}_ACIV_RATE2)
				  	 
				   END W${j}_ACIV_RATE2
			 	     
				  
				#end
                ------------------------------------------------------------				
				
				
				, SUM(UN0_CNT) AS UN0_CNT                             -- 미달
				, SUM(OB0_CNT) AS OB0_CNT                             -- 계획준수
				, NULLIF(SUM (ISNULL(UN0_CNT, 0) + ISNULL(OB0_CNT, 0)), 0) AS CMPL_CNT   -- 합계
			FROM 
			(
				SELECT CT.COMPANY_CD
	                 , CT.BU_CD
	                 , ISNULL (CT.REP_ITEM_GROUP_CD, ' ') AS REP_ITEM_GROUP_CD 
	                 , ISNULL (CT.REP_ITEM_GROUP_CD, ' ') AS REP_ITEM_GROUP_CD_NM 
	                 , ISNULL (CT.REP_ITEM_GROUP_NM, ' ') AS REP_ITEM_GROUP_NM 
	                 , ISNULL (CT.REP_ITEM_GROUP_NM, ' ') AS REP_ITEM_GROUP_NM_NM 
	                 , ISNULL (CT.ROUTING_ID, ' ')        AS ROUTING_ID
	                 , ISNULL (CT.ROUTING_ID, ' ')        AS ROUTING_ID_NM
	                 , ISNULL (CT.REP_CUST_GROUP_CD, ' ') AS REP_CUST_GROUP_CD
	                 , ISNULL (CT.REP_CUST_GROUP_CD, ' ') AS REP_CUST_GROUP_CD_NM
	                 , ISNULL (CT.REP_CUST_GROUP_NM, ' ') AS REP_CUST_GROUP_NM
	                 , ISNULL (CT.REP_CUST_GROUP_NM, ' ') AS REP_CUST_GROUP_NM_NM
	                 , ISNULL (CT.CUST_GROUP_CD, ' ')     AS CUST_GROUP_CD
	                 , ISNULL (CT.CUST_GROUP_CD, ' ')     AS CUST_GROUP_CD_NM
	                 , ISNULL (CT.CUST_GROUP_NM, ' ')     AS CUST_GROUP_NM
	                 , ISNULL (CT.CUST_GROUP_NM, ' ')     AS CUST_GROUP_NM_NM
	                 , ISNULL (CT.ITEM_GROUP_CD, ' ')     AS ITEM_GROUP_CD
	                 , ISNULL (CT.ITEM_GROUP_CD, ' ')     AS ITEM_GROUP_CD_NM
	                 , ISNULL (CT.ITEM_GROUP_NM, ' ')     AS ITEM_GROUP_NM
	                 , ISNULL (CT.ITEM_GROUP_NM, ' ')     AS ITEM_GROUP_NM_NM
	                 , ISNULL (CT.ITEM_CD, ' ')           AS ITEM_CD
	                 , ISNULL (CT.ITEM_CD, ' ')           AS ITEM_CD_NM
	                 , ISNULL (CT.ITEM_NM, ' ')           AS ITEM_NM
	                 , ISNULL (CT.ITEM_NM, ' ')           AS ITEM_NM_NM
	                 , ISNULL (CT.SPEC, ' ')              AS SPEC
	                 , ISNULL (CT.SPEC, ' ')              AS SPEC_NM
	                 , ISNULL (CT.DRAW_NO, ' ')           AS DRAW_NO
	                 , ISNULL (CT.DRAW_NO, ' ')           AS DRAW_NO_NM
	                 , ISNULL (CT.ITEM_TYPE, ' ')         AS ITEM_TYPE_CD
	                 , ISNULL (CT.ITEM_TYPE, ' ')         AS ITEM_TYPE_CD_NM
	                 , ISNULL (CT.ITEM_TYPE_NM, ' ')      AS ITEM_TYPE_NM
	                 , ISNULL (CT.ITEM_TYPE_NM, ' ')      AS ITEM_TYPE_NM_NM
	                 , ISNULL (CT.SALES_ORG_LVL4_CD, ' ') AS SALES_ORG_LVL4_CD
	                 , ISNULL (CT.SALES_ORG_LVL4_CD, ' ') AS SALES_ORG_LVL4_CD_NM
	                 , ISNULL (CT.SALES_ORG_LVL4_NM, ' ') AS SALES_ORG_LVL4_NM
	                 , ISNULL (CT.SALES_ORG_LVL4_NM, ' ') AS SALES_ORG_LVL4_NM_NM
	                 , ISNULL (CT.SALES_ORG_LVL5_CD, ' ') AS SALES_ORG_LVL5_CD
	                 , ISNULL (CT.SALES_ORG_LVL5_CD, ' ') AS SALES_ORG_LVL5_CD_NM
	                 , ISNULL (CT.SALES_ORG_LVL5_NM, ' ') AS SALES_ORG_LVL5_NM
	                 , ISNULL (CT.SALES_ORG_LVL5_NM, ' ') AS SALES_ORG_LVL5_NM_NM
	                 , ISNULL (CT.CLEANING_YN, ' ') AS CLEANING_YN
	                 , ISNULL (CT.CLEANING_YN, ' ') AS CLEANING_YN_NM
	                 , ISNULL (CAST (CT.SALES_PRICE_KRW AS NVARCHAR(20)), CAST (CT.ITEM_COST_KRW AS NVARCHAR(20))) AS SALES_PRICE_KRW
	                 , ISNULL (CAST (CT.SALES_PRICE_KRW AS NVARCHAR(20)), CAST (CT.ITEM_COST_KRW AS NVARCHAR(20))) AS SALES_PRICE_KRW_NM
	                 , SUM(CASE WHEN ISP.FLAG = 'FQC_DATA' THEN QTY ELSE NULL END) AS FQC_DATA
#if($_parameter.week == "STD")
					 , SUM(CASE WHEN ISP.RELEASE_DATE BETWEEN @P_W0_REQ_SUN AND @P_W0_REQ_SAT THEN ISP.DEFECT_QTY ELSE NULL END) AS W0_DEFECT_QTY
	                 , SUM(CASE WHEN ISP.RELEASE_DATE BETWEEN @P_W0_REQ_SUN AND @P_W0_REQ_SAT THEN (ISP.GOODS_QTY - ISP.SPEC_QTY) ELSE NULL END) AS W0_CMPL_QTY
	                 , SUM(CASE WHEN ISP.RELEASE_DATE BETWEEN @P_W0_REQ_SUN AND @P_W0_REQ_SAT THEN ISP.SPEC_QTY ELSE NULL END) AS W0_SPEC_QTY
					 #foreach( $i in $weekArr2 )
					 #set($j = $i - 1)
	                 , SUM(CASE WHEN ISP.FLAG = 'W_${j}' AND ISP.YEARWEEK = @P_W${j}_WEEK THEN ISP.QTY ELSE NULL END ) AS W${j}_PL_QTY 
	                 , CASE WHEN SUM ( CASE WHEN ISP.FLAG = 'W_${j}' AND ISP.YEARWEEK = @P_W${j}_WEEK THEN ISP.QTY ELSE NULL END ) <![CDATA[>]]> 0
	                        THEN 1
	                        ELSE 0
	                    END W${j}_PL_CNT
	                 , SUM(CASE WHEN ISP.RELEASE_DATE BETWEEN @P_W${j}_REQ_SUN AND @P_W${j}_REQ_SAT 
	                             THEN ISP.GOODS_QTY 
	                           	 ELSE NULL 
	                         END
	                       ) AS W${j}_GOODS_QTY
	                 , CASE WHEN @{fromWeek} <![CDATA[<=]]> '201939' THEN NULL  
	                        WHEN ISNULL(SUM(CASE WHEN ISP.FLAG = 'W_${i}_PERFORM' THEN ISP.CMPL_QTY ELSE NULL END), 0) - ISNULL(SUM(CASE WHEN ISP.FLAG = 'W_${i}_PLAN' THEN ISP.QTY ELSE NULL END), 0) <![CDATA[>]]> 0
						    THEN ISNULL(SUM(CASE WHEN ISP.FLAG = 'W_${i}_PERFORM' THEN ISP.CMPL_QTY ELSE NULL END), 0) - ISNULL(SUM(CASE WHEN ISP.FLAG = 'W_${i}_PLAN' THEN ISP.QTY ELSE NULL END), 0)
						   ELSE NULL
					   END W${i}_PREPRODUCTION_QTY
	                 , CASE WHEN SUM(CASE WHEN ISP.FLAG = 'W_${j}' AND ISP.YEARWEEK = @P_W${j}_WEEK THEN ISP.QTY ELSE 0 END ) = 0 THEN NULL 
	                        ELSE CASE WHEN 
					             ((
					             	ISNULL(
					             			CASE WHEN @{fromWeek} <![CDATA[<=]]> '201939' THEN NULL
					             				 WHEN ISNULL(SUM(CASE WHEN ISP.FLAG = 'W_${i}_PERFORM' THEN ISP.CMPL_QTY ELSE NULL END), 0) - ISNULL(SUM(CASE WHEN ISP.FLAG = 'W_${i}_PLAN' THEN ISP.QTY ELSE NULL END), 0) <![CDATA[>]]> 0
												 THEN ISNULL(SUM(CASE WHEN ISP.FLAG = 'W_${i}_PERFORM' THEN ISP.CMPL_QTY ELSE NULL END), 0) - ISNULL(SUM(CASE WHEN ISP.FLAG = 'W_${i}_PLAN' THEN ISP.QTY ELSE NULL END), 0)
												 ELSE NULL
											END, 0) 
									+
									ISNULL(SUM (CASE WHEN ISP.RELEASE_DATE BETWEEN @P_W${j}_REQ_SUN AND @P_W${j}_REQ_SAT 
						                             THEN ISP.GOODS_QTY 
						                             ELSE NULL 
												 END), 0)
								) / NULLIF(SUM(CASE WHEN ISP.FLAG = 'W_${j}' AND ISP.YEARWEEK = @P_W${j}_WEEK THEN ISP.QTY ELSE NULL END), 0)) * 100 <![CDATA[<]]> @P_UN_RATE 
									THEN 1
									ELSE NULL
							 	END
					    END UN${j}_CNT			
	                 , CASE WHEN SUM(CASE WHEN ISP.FLAG = 'W_${j}' AND ISP.YEARWEEK = @P_W${j}_WEEK THEN ISP.QTY ELSE 0 END ) = 0 THEN NULL 
	                        ELSE CASE WHEN ISNULL(SUM(CASE WHEN ISP.FLAG = 'W_${j}' AND ISP.YEARWEEK = @P_W${j}_WEEK THEN ISP.QTY ELSE NULL END), 0) = 0 
		                             AND
		                             SUM(CASE WHEN ISP.RELEASE_DATE BETWEEN @P_W${j}_REQ_SUN AND @P_W${j}_REQ_SAT 
				                              THEN ISP.GOODS_QTY 
				                           	  ELSE 0 
				                          END
				                       ) <![CDATA[>]]> 0 THEN 1
					                WHEN 
					                 ((
					                 	ISNULL(
					                 			CASE WHEN @{fromWeek} <![CDATA[<=]]> '201939' THEN NULL
					                 			     WHEN ISNULL(SUM(CASE WHEN ISP.FLAG = 'W_${i}_PERFORM' THEN ISP.CMPL_QTY ELSE NULL END), 0) - ISNULL(SUM(CASE WHEN ISP.FLAG = 'W_${i}_PLAN' THEN ISP.QTY ELSE NULL END), 0) <![CDATA[>]]> 0
													 THEN ISNULL(SUM(CASE WHEN ISP.FLAG = 'W_${i}_PERFORM' THEN ISP.CMPL_QTY ELSE NULL END), 0) - ISNULL(SUM(CASE WHEN ISP.FLAG = 'W_${i}_PLAN' THEN ISP.QTY ELSE NULL END), 0)
													 ELSE NULL
									   			END, 0) 
									   	+
									   	ISNULL(SUM (CASE WHEN ISP.RELEASE_DATE BETWEEN @P_W${j}_REQ_SUN AND @P_W${j}_REQ_SAT 
						                                 THEN ISP.GOODS_QTY 
						                                 ELSE NULL 
													END), 0)
									  ) / NULLIF(SUM(CASE WHEN ISP.FLAG = 'W_${j}' AND ISP.YEARWEEK = @P_W${j}_WEEK THEN ISP.QTY ELSE NULL END), 0)) * 100 <![CDATA[>=]]> @P_UN_RATE 
											THEN 1
											ELSE NULL
					 			END 
					 	END OB${j}_CNT	      
					 	
					 			 	
					#end 
					
					--210608 김수호 추가 
					--------------------------------------------------------------------------------------
					#foreach( $i in $weekArr2 )
                    #set($j = $i - 1)
					   
                       , CASE WHEN ((ISNULL(SUM(CASE WHEN ISP.RELEASE_DATE BETWEEN @P_W${j}_REQ_SUN AND @P_W${j}_REQ_SAT 
                                                  THEN ISP.GOODS_QTY 
                                                ELSE NULL 
                                                END
                                                ), 0) + ISNULL(CASE WHEN @{fromWeek} <![CDATA[<=]]> '201939' THEN NULL  
                                                               WHEN ISNULL(SUM(CASE WHEN ISP.FLAG = 'W_${i}_PERFORM' THEN ISP.CMPL_QTY ELSE NULL END), 0) - ISNULL(SUM(CASE WHEN ISP.FLAG = 'W_${i}_PLAN' THEN ISP.QTY ELSE NULL END), 0) <![CDATA[>]]> 0
                                                                THEN ISNULL(SUM(CASE WHEN ISP.FLAG = 'W_${i}_PERFORM' THEN ISP.CMPL_QTY ELSE NULL END), 0) - ISNULL(SUM(CASE WHEN ISP.FLAG = 'W_${i}_PLAN' THEN ISP.QTY ELSE NULL END), 0)
                                                               ELSE NULL
                                                               END, 0)) / NULLIF(SUM(CASE WHEN ISP.FLAG = 'W_${j}' AND ISP.YEARWEEK = @P_W${j}_WEEK THEN ISP.QTY ELSE NULL END ), 0) * 100) <![CDATA[>]]> 100 THEN 100
                        
                        ELSE (ISNULL(SUM(CASE WHEN ISP.RELEASE_DATE BETWEEN @P_W${j}_REQ_SUN AND @P_W${j}_REQ_SAT 
                                 THEN ISP.GOODS_QTY 
                                 ELSE NULL 
                             END
                           ), 0) + ISNULL(CASE WHEN @{fromWeek} <![CDATA[<=]]> '201939' THEN NULL  
                            WHEN ISNULL(SUM(CASE WHEN ISP.FLAG = 'W_${i}_PERFORM' THEN ISP.CMPL_QTY ELSE NULL END), 0) - ISNULL(SUM(CASE WHEN ISP.FLAG = 'W_${i}_PLAN' THEN ISP.QTY ELSE NULL END), 0) <![CDATA[>]]> 0
                            THEN ISNULL(SUM(CASE WHEN ISP.FLAG = 'W_${i}_PERFORM' THEN ISP.CMPL_QTY ELSE NULL END), 0) - ISNULL(SUM(CASE WHEN ISP.FLAG = 'W_${i}_PLAN' THEN ISP.QTY ELSE NULL END), 0)
                           ELSE NULL
                       END, 0)) / NULLIF(SUM(CASE WHEN ISP.FLAG = 'W_${j}' AND ISP.YEARWEEK = @P_W${j}_WEEK THEN ISP.QTY ELSE NULL END ), 0) * 100
                      
                        END W${j}_ACIV_RATE2
                        
          
					#end
					--------------------------------------------------------------------------------------
#elseif($_parameter.week == "SALES")
					 , SUM(CASE WHEN ISP.FLAG = 'W_0_ETC' THEN ISP.DEFECT_QTY ELSE NULL END) AS W0_DEFECT_QTY
	                 , SUM(CASE WHEN ISP.FLAG = 'W_0_ETC' THEN (ISP.GOODS_QTY - ISP.SPEC_QTY) ELSE NULL END) AS W0_CMPL_QTY
	                 , SUM(CASE WHEN ISP.FLAG = 'W_0_ETC' THEN ISP.SPEC_QTY ELSE NULL END) AS W0_SPEC_QTY
					#foreach( $i in $weekArr2 )
					#set($j = $i - 1)
					 , SUM(CASE WHEN ISP.FLAG = 'W_${j}' THEN ISP.QTY ELSE NULL END) AS W${j}_PL_QTY 
	                 , CASE WHEN SUM(CASE WHEN ISP.FLAG = 'W_${j}' THEN ISP.QTY ELSE NULL END) <![CDATA[>]]> 0 THEN 1 ELSE 0 END W${j}_PL_CNT
	                 , SUM(CASE WHEN ISP.FLAG = 'W_0_ETC' THEN ISP.GOODS_QTY ELSE NULL END) AS W${j}_GOODS_QTY
	                 , CASE WHEN @{fromWeek} <![CDATA[<=]]> '201939' THEN NULL  
	                        WHEN ISNULL(SUM(CASE WHEN ISP.FLAG = 'W_${i}_PERFORM' THEN ISP.CMPL_QTY ELSE NULL END), 0) - ISNULL(SUM(CASE WHEN ISP.FLAG = 'W_${i}_PLAN' THEN ISP.QTY ELSE NULL END), 0) <![CDATA[>]]> 0
						    THEN ISNULL(SUM(CASE WHEN ISP.FLAG = 'W_${i}_PERFORM' THEN ISP.CMPL_QTY ELSE NULL END), 0) - ISNULL(SUM(CASE WHEN ISP.FLAG = 'W_${i}_PLAN' THEN ISP.QTY ELSE NULL END), 0)
						   ELSE NULL
					   END W${i}_PREPRODUCTION_QTY
	                 , CASE WHEN SUM(CASE WHEN ISP.FLAG = 'W_${j}' THEN ISP.QTY ELSE 0 END ) = 0 THEN NULL 
	                        ELSE CASE WHEN 
					             ((
					             	ISNULL(
					             			CASE WHEN @{fromWeek} <![CDATA[<=]]> '201939' THEN NULL
					             				 WHEN ISNULL(SUM(CASE WHEN ISP.FLAG = 'W_${i}_PERFORM' THEN ISP.CMPL_QTY ELSE NULL END), 0) - ISNULL(SUM(CASE WHEN ISP.FLAG = 'W_${i}_PLAN' THEN ISP.QTY ELSE NULL END), 0) <![CDATA[>]]> 0
												 THEN ISNULL(SUM(CASE WHEN ISP.FLAG = 'W_${i}_PERFORM' THEN ISP.CMPL_QTY ELSE NULL END), 0) - ISNULL(SUM(CASE WHEN ISP.FLAG = 'W_${i}_PLAN' THEN ISP.QTY ELSE NULL END), 0)
												 ELSE NULL
											END, 0) 
									+
									ISNULL(SUM (CASE WHEN ISP.FLAG = 'W_${j}_ETC'  
						                             THEN ISP.GOODS_QTY 
						                             ELSE NULL 
												 END), 0)
								) / NULLIF(SUM(CASE WHEN ISP.FLAG = 'W_${j}' THEN ISP.QTY ELSE NULL END), 0)) * 100 <![CDATA[<]]> @P_UN_RATE 
									THEN 1
									ELSE NULL
							 	END
					    END UN${j}_CNT			
	                 , CASE WHEN SUM(CASE WHEN ISP.FLAG = 'W_${j}' THEN ISP.QTY ELSE 0 END ) = 0 THEN NULL 
	                        ELSE CASE WHEN ISNULL(SUM(CASE WHEN ISP.FLAG = 'W_${j}' THEN ISP.QTY ELSE NULL END), 0) = 0 
		                             AND
		                             SUM(CASE WHEN ISP.FLAG = 'W_${j}_ETC' 
				                              THEN ISP.GOODS_QTY 
				                           	  ELSE 0 
				                          END
				                       ) <![CDATA[>]]> 0 THEN 1
					                WHEN 
					                 ((
					                 	ISNULL(
					                 			CASE WHEN @{fromWeek} <![CDATA[<=]]> '201939' THEN NULL
					                 			     WHEN ISNULL(SUM(CASE WHEN ISP.FLAG = 'W_${i}_PERFORM' THEN ISP.CMPL_QTY ELSE NULL END), 0) - ISNULL(SUM(CASE WHEN ISP.FLAG = 'W_${i}_PLAN' THEN ISP.QTY ELSE NULL END), 0) <![CDATA[>]]> 0
													 THEN ISNULL(SUM(CASE WHEN ISP.FLAG = 'W_${i}_PERFORM' THEN ISP.CMPL_QTY ELSE NULL END), 0) - ISNULL(SUM(CASE WHEN ISP.FLAG = 'W_${i}_PLAN' THEN ISP.QTY ELSE NULL END), 0)
													 ELSE NULL
									   			END, 0) 
									   	+
									   	ISNULL(SUM (CASE WHEN ISP.FLAG = 'W_${j}_ETC' 
						                                 THEN ISP.GOODS_QTY 
						                                 ELSE NULL 
													END), 0)
									  ) / NULLIF(SUM(CASE WHEN ISP.FLAG = 'W_${j}' THEN ISP.QTY ELSE NULL END), 0)) * 100 <![CDATA[>=]]> @P_UN_RATE 
											THEN 1
											ELSE NULL
					 			END 
					 	END OB${j}_CNT	      
					 	
					 
					#end
					
					--210608 김수호 추가 
					---------------------------------------------------------------------------------------------------------------------------------
					#foreach( $i in $weekArr2 )
                    #set($j = $i - 1)
                   
                    , CASE WHEN ((ISNULL(SUM(CASE WHEN ISP.FLAG = 'W_0_ETC' THEN ISP.GOODS_QTY ELSE NULL END), 0) + ISNULL(CASE WHEN @{fromWeek} <![CDATA[<=]]> '201939' THEN NULL  
                            WHEN ISNULL(SUM(CASE WHEN ISP.FLAG = 'W_${i}_PERFORM' THEN ISP.CMPL_QTY ELSE NULL END), 0) - ISNULL(SUM(CASE WHEN ISP.FLAG = 'W_${i}_PLAN' THEN ISP.QTY ELSE NULL END), 0) <![CDATA[>]]> 0
                            THEN ISNULL(SUM(CASE WHEN ISP.FLAG = 'W_${i}_PERFORM' THEN ISP.CMPL_QTY ELSE NULL END), 0) - ISNULL(SUM(CASE WHEN ISP.FLAG = 'W_${i}_PLAN' THEN ISP.QTY ELSE NULL END), 0)
                           ELSE NULL
                       END, 0)) / NULLIF(SUM(CASE WHEN ISP.FLAG = 'W_${j}' THEN ISP.QTY ELSE NULL END), 0) * 100) <![CDATA[>]]> 100 THEN 100
                        ELSE (ISNULL(SUM(CASE WHEN ISP.FLAG = 'W_0_ETC' THEN ISP.GOODS_QTY ELSE NULL END), 0) + ISNULL(CASE WHEN @{fromWeek} <![CDATA[<=]]> '201939' THEN NULL  
                            WHEN ISNULL(SUM(CASE WHEN ISP.FLAG = 'W_${i}_PERFORM' THEN ISP.CMPL_QTY ELSE NULL END), 0) - ISNULL(SUM(CASE WHEN ISP.FLAG = 'W_${i}_PLAN' THEN ISP.QTY ELSE NULL END), 0) <![CDATA[>]]> 0
                            THEN ISNULL(SUM(CASE WHEN ISP.FLAG = 'W_${i}_PERFORM' THEN ISP.CMPL_QTY ELSE NULL END), 0) - ISNULL(SUM(CASE WHEN ISP.FLAG = 'W_${i}_PLAN' THEN ISP.QTY ELSE NULL END), 0)
                           ELSE NULL
                       END, 0)) / NULLIF(SUM(CASE WHEN ISP.FLAG = 'W_${j}' THEN ISP.QTY ELSE NULL END), 0) * 100
                        END W${j}_ACIV_RATE2
                   
                    #end
	
                    ---------------------------------------------------------------------------------------------------------------------------------				
					
					
#end
				FROM W_ITEM CT
				INNER JOIN W_INSP ISP WITH(NOLOCK)
		           ON CT.COMPANY_CD = ISP.COMPANY_CD
		          AND CT.BU_CD      = ISP.BU_CD
		          AND CT.ITEM_CD    = ISP.ITEM_CD
		        WHERE CT.COMPANY_CD = @{GV_COMPANY_CD}
		          AND CT.BU_CD      = @{GV_BU_CD}
		          AND CT.PROCUR_TYPE_CD IN ('MG', 'MH')
           	  	  AND CT.ITEM_TYPE IN ('10', '20')
		  		#if($_parameter.item_cd and $_parameter.item_cd != "")
		          AND CT.ITEM_CD IN ('$_parameter.item_cd.replace(",","','")')
		  		#elseif($_parameter.item_nm and $_parameter.item_nm != "")
		          AND (CT.ITEM_CD LIKE '%'+@{item_nm}+'%' OR CT.ITEM_NM LIKE '%'+@{item_nm}+'%')
		  		#end
		  		#if($_parameter.itemGroup and $_parameter.itemGroup != "")
		          AND CT.ITEM_GROUP_CD IN ('$_parameter.itemGroup.replace(",","','")')
		  		#end
		  		#if($_parameter.route and $_parameter.route != "")
		          AND CT.ROUTING_ID IN ('$_parameter.route.replace(",","','")')
		  		#end
				GROUP BY CT.COMPANY_CD, CT.BU_CD, CT.REP_ITEM_GROUP_CD, CT.REP_ITEM_GROUP_NM, CT.ROUTING_ID, CT.REP_CUST_GROUP_CD, CT.REP_CUST_GROUP_NM, CT.CUST_GROUP_CD, CT.CUST_GROUP_NM 
		               , CT.ITEM_GROUP_CD, CT.ITEM_GROUP_NM, CT.ITEM_CD, CT.ITEM_NM, CT.SPEC, CT.DRAW_NO, CT.ITEM_TYPE, CT.ITEM_TYPE_NM, CT.SALES_ORG_LVL4_CD, CT.SALES_ORG_LVL4_NM, CT.SALES_ORG_LVL5_CD
		               , CT.SALES_ORG_LVL5_NM, CT.SALES_PRICE_KRW, CT.CLEANING_YN, CT.ITEM_COST_KRW
			) A
		    WHERE 1 = 1
			#if($_parameter.cpRt and $_parameter.cpRt != "")
				#if($_parameter.cpRt == "UN")
		    	  AND UN0_CNT = 1
				#elseif($_parameter.cpRt == "OB")
		    	  AND OB0_CNT = 1
		  		#end
			#end
		    GROUP BY ROLLUP ( <include refid="include.getCdRollup"/> )
		    ORDER BY TMP_COL
			#foreach( $dimMap in $_parameter.dimList )
		    	, A.$dimMap.DIM_CD
			#end
			
			
		END;
		<!-- #set($weekArr  = [0..4])
		#set($weekArr2  = [1..5])
		
		BEGIN
		
		    DECLARE @P_UN_RATE NUMERIC(21, 6); 
		    DECLARE @P_OB_RATE NUMERIC(21, 6);
		    DECLARE @P_EX_RATE NUMERIC(21, 6);
		    DECLARE @FQC_DATE  NVARCHAR(8);
		    
		    SELECT @P_UN_RATE = CAST (MAX (CASE WHEN CODE_CD = 'UN' THEN ATTB_1_CD ELSE NULL END) AS NUMERIC(21, 6))
		         , @P_OB_RATE = CAST (MAX (CASE WHEN CODE_CD = 'OB' THEN ATTB_1_CD ELSE NULL END) AS NUMERIC(21, 6))
		         , @P_EX_RATE = CAST (MAX (CASE WHEN CODE_CD = 'EX' THEN ATTB_1_CD ELSE NULL END) AS NUMERIC(21, 6))
		    FROM TB_MST_CODE
		    WHERE GROUP_CD = 'COMPLIANCE_RATE';
		    
		    #if($_parameter.resultCurrYn == "Y")
		    	SELECT @FQC_DATE = CONVERT(VARCHAR, DBO.UFN_GETDATE(), 112);
		    #else
		    	SELECT @FQC_DATE = CONVERT(VARCHAR, CONVERT(DATETIME, B1.YYYYMMDD) + CONVERT(INTEGER, 7), 112)
				FROM TB_MST_CALENDAR B1 WITH(NOLOCK)
				WHERE B1.YEARWEEK = @{fromWeek}
				  AND B1.DAY_NM = 'SUN';
		    #end
		    
		    DECLARE @P_W0_REQ_STRT NVARCHAR(8) = @{swFromDate};
		    DECLARE @P_W0_REQ_END  NVARCHAR(8) = @{swToDate};
		    DECLARE @P_W0_WEEK     NVARCHAR(6) = (SELECT YEARWEEK FROM TB_MST_CALENDAR WHERE YYYYMMDD = @{swFromDate});
		    
			#foreach( $i in $weekArr2 )
		  	#set( $idx = $foreach.count - 1 )
			    DECLARE @P_W${i}_REQ_STRT NVARCHAR(8) = CONVERT (NVARCHAR (30), DATEADD (DAY, -7, CAST (@P_W${idx}_REQ_STRT AS DATE)), 112);
			    DECLARE @P_W${i}_REQ_END  NVARCHAR(8) = CONVERT (NVARCHAR (30), DATEADD (DAY, -7, CAST (@P_W${idx}_REQ_END  AS DATE)), 112);
			    DECLARE @P_W${i}_WEEK     NVARCHAR(6) = (SELECT YEARWEEK FROM TB_MST_CALENDAR WHERE YYYYMMDD = CONVERT(NVARCHAR(8), DATEADD(DAY, (-7 * ${i}), CAST(@{swFromDate} AS DATE)), 112));
			    DECLARE @P_W${i}_REQ_STRT2 NVARCHAR(8) = CONVERT (NVARCHAR (30), DATEADD (DAY, 4, CAST (@P_W${i}_REQ_STRT AS DATE)), 112);
			#end
		    
		    WITH W_ITEM AS 
			(
			    <include refid="snop.common.t_itemCust" />
			),
			W_INSP AS 
			(
			    SELECT ISP.COMPANY_CD
			         , ISP.BU_CD
			         , ISP.ITEM_CD
			         , ISP.LOT_SIZE
			         , ISP.INSP_QTY
			         , ISP.GOODS_QTY
			         , ISP.DEFECT_QTY
			         , (ISP.GOODS_QTY - ISP.SPEC_QTY) AS CMPL_QTY
			         , ISP.SPEC_QTY
			         , NULL AS ADJ_INSP_REQ_DATE
			         , ISP.RELEASE_DATE
			         , NULL YEARWEEK
			         , NULL QTY
			         , NULL FLAG
			    FROM TB_DYN_INSPECTION ISP WITH (NOLOCK)
			    WHERE ISP.COMPANY_CD = @{GV_COMPANY_CD}
			      AND ISP.BU_CD      = @{GV_BU_CD} 
			      AND ISP.PLANT_CD   = 'WF01'
			      AND DEL_FLAG       = 'N'
			      AND RELEASE_DATE BETWEEN @P_W5_REQ_STRT AND @P_W0_REQ_END
				UNION ALL
          		SELECT DGP.COMPANY_CD
					 , DGP.BU_CD
		             , DGP.ITEM_CD
		             , DGP.GR_QTY AS LOT_SIZE
		             , DGP.GR_QTY AS INSP_QTY
		             , DGP.GR_QTY AS GOODS_QTY
		             , NULL AS DEFECT_QTY
		             , DGP.GR_QTY AS CMPL_QTY
		             , NULL AS SPEC_QTY
		             , NULL AS ADJ_INSP_REQ_DATE
		             , DGP.GR_DATE AS RELEASE_DATE
		             , NULL YEARWEEK
		             , NULL QTY
		             , NULL FLAG
				FROM TB_DYN_GR_PROD DGP WITH(NOLOCK)
		        WHERE DGP.COMPANY_CD = @{GV_COMPANY_CD}
		          AND DGP.BU_CD = @{GV_BU_CD} 
		          AND DGP.PLANT_CD = 'WF01'
		          AND DGP.GR_DATE BETWEEN @P_W5_REQ_STRT AND @P_W0_REQ_END
		          AND EXISTS (
								SELECT 1
		                        FROM TB_MST_ITEM_PLANT MIP WITH(NOLOCK)
		                        WHERE MIP.COMPANY_CD = DGP.COMPANY_CD
		                          AND MIP.BU_CD = DGP.BU_CD
		                          AND MIP.PLANT_CD = DGP.PLANT_CD
		                          AND MIP.ITEM_CD = DGP.ITEM_CD
		                          AND MIP.ITEM_TYPE = '20'
		                          AND MIP.PROCUR_TYPE IN ('MG', 'MH')
		                     )			      
			    UNION ALL
			    SELECT PP.COMPANY_CD
			         , PP.BU_CD
			         , PP.ITEM_CD
			         , NULL
			         , NULL
			         , NULL
			         , NULL
			         , NULL
			         , NULL
			         , NULL
			         , NULL
			         , YEARWEEK
			         , PP.QTY
			         , 'W_4' AS FLAG
			    FROM TB_DYN_PROD_PLAN PP WITH(NOLOCK)
	          	WHERE COMPANY_CD = @{GV_COMPANY_CD}
			      AND BU_CD      = @{GV_BU_CD} 
			      AND YEARWEEK   = @P_W4_WEEK
	          	UNION ALL
	          	SELECT PP.COMPANY_CD
		             , PP.BU_CD
		             , PP.ITEM_CD
		             , NULL
		             , NULL
		             , NULL
		             , NULL
		             , NULL
		             , NULL
		             , NULL
		             , NULL
		             , YEARWEEK
		             , PP.QTY
		             , 'W_3' AS FLAG
	          	FROM TB_DYN_PROD_PLAN PP WITH(NOLOCK)
	          	WHERE COMPANY_CD = @{GV_COMPANY_CD}
			      AND BU_CD      = @{GV_BU_CD} 
			      AND YEARWEEK   = @P_W3_WEEK
	          	UNION ALL
	          	SELECT PP.COMPANY_CD
			         , PP.BU_CD
			         , PP.ITEM_CD
			         , NULL
			         , NULL
			         , NULL
			         , NULL
			         , NULL
			         , NULL
			         , NULL
			         , NULL
			         , YEARWEEK
			         , PP.QTY
			         , 'W_2' AS FLAG
	          	FROM TB_DYN_PROD_PLAN PP WITH(NOLOCK)
	          	WHERE COMPANY_CD = @{GV_COMPANY_CD}
			      AND BU_CD      = @{GV_BU_CD} 
			      AND YEARWEEK   = @P_W2_WEEK
	          	UNION ALL
	          	SELECT PP.COMPANY_CD
			         , PP.BU_CD
			         , PP.ITEM_CD
			         , NULL
			         , NULL
			         , NULL
			         , NULL
			         , NULL
			         , NULL
			         , NULL
			         , NULL
			         , YEARWEEK
			         , PP.QTY
			         , 'W_1' AS FLAG
	          	FROM TB_DYN_PROD_PLAN PP WITH(NOLOCK)
	          	WHERE COMPANY_CD = @{GV_COMPANY_CD}
			      AND BU_CD      = @{GV_BU_CD} 
			      AND YEARWEEK   = @P_W1_WEEK
	          	UNION ALL
	          	SELECT PP.COMPANY_CD
			         , PP.BU_CD
			         , PP.ITEM_CD
			         , NULL
			         , NULL
			         , NULL
			         , NULL
			         , NULL
			         , NULL
			         , NULL
			         , NULL
			         , YEARWEEK
			         , PP.QTY
			         , 'W_0' AS FLAG
	          	FROM TB_DYN_PROD_PLAN PP WITH(NOLOCK)
          		WHERE COMPANY_CD = @{GV_COMPANY_CD}
			      AND BU_CD      = @{GV_BU_CD} 
			      AND YEARWEEK   = @P_W0_WEEK
			      
	          	/*선행생산 실적 */
	          	UNION ALL
				SELECT ISP.COMPANY_CD
				     , ISP.BU_CD
				     , ISP.ITEM_CD
				     , NULL
				     , NULL
				     , NULL
				     , NULL
				     , ISP.GOODS_QTY AS CMPL_QTY
				     , NULL
				     , NULL
				     , ISP.RELEASE_DATE
				     , NULL YEARWEEK
				     , NULL QTY
				     , 'W_1_PERFORM' FLAG
				FROM TB_DYN_INSPECTION ISP WITH (NOLOCK)
				WHERE ISP.COMPANY_CD = @{GV_COMPANY_CD}
			  	  AND ISP.BU_CD      = @{GV_BU_CD} 
			  	  AND ISP.PLANT_CD   = 'WF01'
			  	  AND DEL_FLAG       = 'N'
			  	  AND RELEASE_DATE BETWEEN @P_W1_REQ_STRT2 AND @P_W1_REQ_END
				UNION ALL
          		SELECT DGP.COMPANY_CD
	                 , DGP.BU_CD
	                 , DGP.ITEM_CD
	                 , NULL
	                 , NULL
	                 , NULL
	                 , NULL
	                 , DGP.GR_QTY AS CMPL_QTY
	                 , NULL
	                 , NULL
	                 , DGP.GR_DATE AS RELEASE_DATE
	                 , NULL YEARWEEK
	                 , NULL QTY
	                 , 'W_1_PERFORM' FLAG
				FROM TB_DYN_GR_PROD DGP WITH(NOLOCK)
	           	WHERE DGP.COMPANY_CD = @{GV_COMPANY_CD}
	              AND DGP.BU_CD = @{GV_BU_CD} 
	              AND DGP.PLANT_CD = 'WF01'
	              AND DGP.GR_DATE BETWEEN @P_W1_REQ_STRT2 AND @P_W1_REQ_END
	              AND EXISTS (
                         		SELECT 1
                           		FROM TB_MST_ITEM_PLANT MIP WITH(NOLOCK)
                          		WHERE MIP.COMPANY_CD = DGP.COMPANY_CD
	                              AND MIP.BU_CD = DGP.BU_CD
	                              AND MIP.PLANT_CD = DGP.PLANT_CD
	                              AND MIP.ITEM_CD = DGP.ITEM_CD
	                              AND MIP.ITEM_TYPE = '20'
	                              AND MIP.PROCUR_TYPE IN ('MG', 'MH')
                        	 )
			  	UNION ALL
				SELECT ISP.COMPANY_CD
				     , ISP.BU_CD
				     , ISP.ITEM_CD
				     , NULL
				     , NULL
				     , NULL
				     , NULL
				     , ISP.GOODS_QTY AS CMPL_QTY
				     , NULL
				     , NULL
				     , ISP.RELEASE_DATE
				     , NULL YEARWEEK
				     , NULL QTY
				     , 'W_2_PERFORM' FLAG
				FROM TB_DYN_INSPECTION ISP WITH (NOLOCK)
				WHERE ISP.COMPANY_CD = @{GV_COMPANY_CD}
			  	  AND ISP.BU_CD      = @{GV_BU_CD} 
			  	  AND ISP.PLANT_CD   = 'WF01'
			  	  AND DEL_FLAG       = 'N'
			  	  AND RELEASE_DATE BETWEEN @P_W2_REQ_STRT2 AND @P_W2_REQ_END
				UNION ALL
          		SELECT DGP.COMPANY_CD
	                 , DGP.BU_CD
	                 , DGP.ITEM_CD
	                 , NULL
	                 , NULL
	                 , NULL
	                 , NULL
	                 , DGP.GR_QTY AS CMPL_QTY
	                 , NULL
	                 , NULL
	                 , DGP.GR_DATE AS RELEASE_DATE
	                 , NULL YEARWEEK
	                 , NULL QTY
	                 , 'W_2_PERFORM' FLAG
				FROM TB_DYN_GR_PROD DGP WITH(NOLOCK)
	           	WHERE DGP.COMPANY_CD = @{GV_COMPANY_CD}
	              AND DGP.BU_CD = @{GV_BU_CD} 
	              AND DGP.PLANT_CD = 'WF01'
	              AND DGP.GR_DATE BETWEEN @P_W2_REQ_STRT2 AND @P_W2_REQ_END
	              AND EXISTS (
                         		SELECT 1
                           		FROM TB_MST_ITEM_PLANT MIP WITH(NOLOCK)
                          		WHERE MIP.COMPANY_CD = DGP.COMPANY_CD
	                              AND MIP.BU_CD = DGP.BU_CD
	                              AND MIP.PLANT_CD = DGP.PLANT_CD
	                              AND MIP.ITEM_CD = DGP.ITEM_CD
	                              AND MIP.ITEM_TYPE = '20'
	                              AND MIP.PROCUR_TYPE IN ('MG', 'MH')
                        	 )
			  	UNION ALL
				SELECT ISP.COMPANY_CD
				     , ISP.BU_CD
				     , ISP.ITEM_CD
				     , NULL
				     , NULL
				     , NULL
				     , NULL
				     , ISP.GOODS_QTY AS CMPL_QTY
				     , NULL
				     , NULL
				     , ISP.RELEASE_DATE
				     , NULL YEARWEEK
				     , NULL QTY
				     , 'W_3_PERFORM' FLAG
				FROM TB_DYN_INSPECTION ISP WITH (NOLOCK)
				WHERE ISP.COMPANY_CD = @{GV_COMPANY_CD}
			  	  AND ISP.BU_CD      = @{GV_BU_CD} 
			  	  AND ISP.PLANT_CD   = 'WF01'
			  	  AND DEL_FLAG       = 'N'
			  	  AND RELEASE_DATE BETWEEN @P_W3_REQ_STRT2 AND @P_W3_REQ_END
			  	UNION ALL
          		SELECT DGP.COMPANY_CD
	                 , DGP.BU_CD
	                 , DGP.ITEM_CD
	                 , NULL
	                 , NULL
	                 , NULL
	                 , NULL
	                 , DGP.GR_QTY AS CMPL_QTY
	                 , NULL
	                 , NULL
	                 , DGP.GR_DATE AS RELEASE_DATE
	                 , NULL YEARWEEK
	                 , NULL QTY
	                 , 'W_3_PERFORM' FLAG
				FROM TB_DYN_GR_PROD DGP WITH(NOLOCK)
	           	WHERE DGP.COMPANY_CD = @{GV_COMPANY_CD}
	              AND DGP.BU_CD = @{GV_BU_CD} 
	              AND DGP.PLANT_CD = 'WF01'
	              AND DGP.GR_DATE BETWEEN @P_W3_REQ_STRT2 AND @P_W3_REQ_END
	              AND EXISTS (
                         		SELECT 1
                           		FROM TB_MST_ITEM_PLANT MIP WITH(NOLOCK)
                          		WHERE MIP.COMPANY_CD = DGP.COMPANY_CD
	                              AND MIP.BU_CD = DGP.BU_CD
	                              AND MIP.PLANT_CD = DGP.PLANT_CD
	                              AND MIP.ITEM_CD = DGP.ITEM_CD
	                              AND MIP.ITEM_TYPE = '20'
	                              AND MIP.PROCUR_TYPE IN ('MG', 'MH')
                        	 )
			  	UNION ALL
				SELECT ISP.COMPANY_CD
				     , ISP.BU_CD
				     , ISP.ITEM_CD
				     , NULL
				     , NULL
				     , NULL
				     , NULL
				     , ISP.GOODS_QTY AS CMPL_QTY
				     , NULL
				     , NULL
				     , ISP.RELEASE_DATE
				     , NULL YEARWEEK
				     , NULL QTY
				     , 'W_4_PERFORM' FLAG
				FROM TB_DYN_INSPECTION ISP WITH (NOLOCK)
				WHERE ISP.COMPANY_CD = @{GV_COMPANY_CD}
			  	  AND ISP.BU_CD      = @{GV_BU_CD} 
			  	  AND ISP.PLANT_CD   = 'WF01'
			  	  AND DEL_FLAG       = 'N'
			  	  AND RELEASE_DATE BETWEEN @P_W4_REQ_STRT2 AND @P_W4_REQ_END
			  	UNION ALL
          		SELECT DGP.COMPANY_CD
	                 , DGP.BU_CD
	                 , DGP.ITEM_CD
	                 , NULL
	                 , NULL
	                 , NULL
	                 , NULL
	                 , DGP.GR_QTY AS CMPL_QTY
	                 , NULL
	                 , NULL
	                 , DGP.GR_DATE AS RELEASE_DATE
	                 , NULL YEARWEEK
	                 , NULL QTY
	                 , 'W_4_PERFORM' FLAG
				FROM TB_DYN_GR_PROD DGP WITH(NOLOCK)
	           	WHERE DGP.COMPANY_CD = @{GV_COMPANY_CD}
	              AND DGP.BU_CD = @{GV_BU_CD} 
	              AND DGP.PLANT_CD = 'WF01'
	              AND DGP.GR_DATE BETWEEN @P_W4_REQ_STRT2 AND @P_W4_REQ_END
	              AND EXISTS (
                         		SELECT 1
                           		FROM TB_MST_ITEM_PLANT MIP WITH(NOLOCK)
                          		WHERE MIP.COMPANY_CD = DGP.COMPANY_CD
	                              AND MIP.BU_CD = DGP.BU_CD
	                              AND MIP.PLANT_CD = DGP.PLANT_CD
	                              AND MIP.ITEM_CD = DGP.ITEM_CD
	                              AND MIP.ITEM_TYPE = '20'
	                              AND MIP.PROCUR_TYPE IN ('MG', 'MH')
                        	 )
			  	UNION ALL
				SELECT ISP.COMPANY_CD
				     , ISP.BU_CD
				     , ISP.ITEM_CD
				     , NULL
				     , NULL
				     , NULL
				     , NULL
				     , ISP.GOODS_QTY AS CMPL_QTY
				     , NULL
				     , NULL
				     , ISP.RELEASE_DATE
				     , NULL YEARWEEK
				     , NULL QTY
				     , 'W_5_PERFORM' FLAG
				FROM TB_DYN_INSPECTION ISP WITH (NOLOCK)
				WHERE ISP.COMPANY_CD = @{GV_COMPANY_CD}
			  	  AND ISP.BU_CD      = @{GV_BU_CD} 
			  	  AND ISP.PLANT_CD   = 'WF01'
			  	  AND DEL_FLAG       = 'N'
			  	  AND RELEASE_DATE BETWEEN @P_W5_REQ_STRT2 AND @P_W5_REQ_END
				UNION ALL
          		SELECT DGP.COMPANY_CD
	                 , DGP.BU_CD
	                 , DGP.ITEM_CD
	                 , NULL
	                 , NULL
	                 , NULL
	                 , NULL
	                 , DGP.GR_QTY AS CMPL_QTY
	                 , NULL
	                 , NULL
	                 , DGP.GR_DATE AS RELEASE_DATE
	                 , NULL YEARWEEK
	                 , NULL QTY
	                 , 'W_5_PERFORM' FLAG
				FROM TB_DYN_GR_PROD DGP WITH(NOLOCK)
	           	WHERE DGP.COMPANY_CD = @{GV_COMPANY_CD}
	              AND DGP.BU_CD = @{GV_BU_CD} 
	              AND DGP.PLANT_CD = 'WF01'
	              AND DGP.GR_DATE BETWEEN @P_W5_REQ_STRT2 AND @P_W5_REQ_END
	              AND EXISTS (
                         		SELECT 1
                           		FROM TB_MST_ITEM_PLANT MIP WITH(NOLOCK)
                          		WHERE MIP.COMPANY_CD = DGP.COMPANY_CD
	                              AND MIP.BU_CD = DGP.BU_CD
	                              AND MIP.PLANT_CD = DGP.PLANT_CD
	                              AND MIP.ITEM_CD = DGP.ITEM_CD
	                              AND MIP.ITEM_TYPE = '20'
	                              AND MIP.PROCUR_TYPE IN ('MG', 'MH')
                        	 )
	          
	          	/*선행생산 계획*/
	          	UNION ALL
	          	SELECT PP.COMPANY_CD
			         , PP.BU_CD
			         , PP.ITEM_CD
			         , NULL
			         , NULL
			         , NULL
			         , NULL
			         , NULL
			         , NULL
			         , NULL
			         , NULL
			         , NULL
			         , PP.QTY
			         , 'W_1_PLAN' AS FLAG
	          	FROM TB_HIS_APS_PROD_PLAN_DAILY PP WITH(NOLOCK)
				WHERE PP.COMPANY_CD = @{GV_COMPANY_CD}
			      AND PP.BU_CD      = @{GV_BU_CD} 
			      AND PP.PLAN_ID = @P_W1_REQ_STRT2
	         	  AND PP.YYYYMMDD BETWEEN @P_W1_REQ_STRT2 AND @P_W1_REQ_END
	         	UNION ALL
	          	SELECT PP.COMPANY_CD
			         , PP.BU_CD
			         , PP.ITEM_CD
			         , NULL
			         , NULL
			         , NULL
			         , NULL
			         , NULL
			         , NULL
			         , NULL
			         , NULL
			         , NULL
			         , PP.QTY
			         , 'W_2_PLAN' AS FLAG
	          	FROM TB_HIS_APS_PROD_PLAN_DAILY PP WITH(NOLOCK)
				WHERE PP.COMPANY_CD = @{GV_COMPANY_CD}
			      AND PP.BU_CD      = @{GV_BU_CD} 
			      AND PP.PLAN_ID = @P_W2_REQ_STRT2
	         	  AND PP.YYYYMMDD BETWEEN @P_W2_REQ_STRT2 AND @P_W2_REQ_END
	         	UNION ALL
	          	SELECT PP.COMPANY_CD
			         , PP.BU_CD
			         , PP.ITEM_CD
			         , NULL
			         , NULL
			         , NULL
			         , NULL
			         , NULL
			         , NULL
			         , NULL
			         , NULL
			         , NULL
			         , PP.QTY
			         , 'W_3_PLAN' AS FLAG
	          	FROM TB_HIS_APS_PROD_PLAN_DAILY PP WITH(NOLOCK)
				WHERE PP.COMPANY_CD = @{GV_COMPANY_CD}
			      AND PP.BU_CD      = @{GV_BU_CD} 
			      AND PP.PLAN_ID = @P_W3_REQ_STRT2
	         	  AND PP.YYYYMMDD BETWEEN @P_W3_REQ_STRT2 AND @P_W3_REQ_END
	         	UNION ALL
	          	SELECT PP.COMPANY_CD
			         , PP.BU_CD
			         , PP.ITEM_CD
			         , NULL
			         , NULL
			         , NULL
			         , NULL
			         , NULL
			         , NULL
			         , NULL
			         , NULL
			         , NULL
			         , PP.QTY
			         , 'W_4_PLAN' AS FLAG
	          	FROM TB_HIS_APS_PROD_PLAN_DAILY PP WITH(NOLOCK)
				WHERE PP.COMPANY_CD = @{GV_COMPANY_CD}
			      AND PP.BU_CD      = @{GV_BU_CD} 
			      AND PP.PLAN_ID = @P_W4_REQ_STRT2
	         	  AND PP.YYYYMMDD BETWEEN @P_W4_REQ_STRT2 AND @P_W4_REQ_END
	         	UNION ALL
	          	SELECT PP.COMPANY_CD
			         , PP.BU_CD
			         , PP.ITEM_CD
			         , NULL
			         , NULL
			         , NULL
			         , NULL
			         , NULL
			         , NULL
			         , NULL
			         , NULL
			         , NULL
			         , PP.QTY
			         , 'W_5_PLAN' AS FLAG
	          	FROM TB_HIS_APS_PROD_PLAN_DAILY PP WITH(NOLOCK)
				WHERE PP.COMPANY_CD = @{GV_COMPANY_CD}
			      AND PP.BU_CD      = @{GV_BU_CD} 
			      AND PP.PLAN_ID = @P_W5_REQ_STRT2
	         	  AND PP.YYYYMMDD BETWEEN @P_W5_REQ_STRT2 AND @P_W5_REQ_END
				/* FQC_DATA */	         	
	         	UNION ALL
	         	SELECT DWR.COMPANY_CD
				     , DWR.BU_CD
				     , DPOH.ITEM_CD
				     , NULL
			         , NULL
			         , NULL
			         , NULL
			         , NULL
			         , NULL
			         , NULL
			         , NULL
			         , NULL
			         , DWR.REMAIN_QTY AS QTY
			         , 'FQC_DATA' AS FLAG
				FROM TB_DYN_WIP_ROUTING DWR WITH(NOLOCK)
				INNER JOIN TB_DYN_PROD_ORDER_HDR DPOH WITH(NOLOCK)
				   ON DPOH.COMPANY_CD = DWR.COMPANY_CD
				  AND DPOH.BU_CD = DWR.BU_CD
				  AND DPOH.PROD_ORDER_NO = DWR.PROD_ORDER_NO
				WHERE DWR.COMPANY_CD = @{GV_COMPANY_CD}
			      AND DWR.BU_CD      = @{GV_BU_CD} 
			      AND DWR.WIP_DATE   = @FQC_DATE
			      AND DWR.PROD_OR_QC = 'QC_PART'
			)
		    SELECT NULL AS TMP_COL
			    <include refid="include.getCdDimTotal"/>
			    <include refid="include.getGrpLvlId"/>
			     , SUM(FQC_DATA)      AS FQC_DATA
		         , SUM(W0_PL_CNT)     AS W0_PL_CNT 
		         , SUM(W0_PL_QTY)     AS W0_PL_QTY 
		         , SUM(W0_GOODS_QTY)  AS W0_GOODS_QTY
		         , SUM(W0_DEFECT_QTY) AS W0_DEFECT_QTY
		         , SUM(W0_CMPL_QTY)   AS W0_CMPL_QTY
		         , SUM(W0_SPEC_QTY)   AS W0_SPEC_QTY
		         , SUM(W1_PREPRODUCTION_QTY) AS W1_PREPRODUCTION_QTY
		        #foreach( $i in $weekArr2 )
				#set($j = $i - 1)
		         , CASE WHEN ISNULL(SUM(W${j}_PL_QTY), 0) = 0 AND ISNULL(SUM(W${j}_GOODS_QTY), 0) <![CDATA[>]]> 0 THEN NULL 
		                ELSE (ISNULL(SUM(W${j}_GOODS_QTY), 0) + ISNULL(SUM(W${i}_PREPRODUCTION_QTY), 0)) / NULLIF(SUM(W${j}_PL_QTY), 0) * 100
		            END W${j}_ACIV_RATE
		         , ROUND(CAST(ISNULL(SUM (OB${j}_CNT), 0) AS NUMERIC) / CAST(NULLIF((ISNULL(SUM (OB${j}_CNT), 0) + ISNULL(SUM (UN${j}_CNT), 0)), 0) AS NUMERIC) * 100.0, 0) AS CMPL${j}_RATE
				#end
				, SUM(UN0_CNT) AS UN0_CNT  
				, SUM(OB0_CNT) AS OB0_CNT      
				, NULLIF(SUM (ISNULL(UN0_CNT, 0) + ISNULL(OB0_CNT, 0)), 0) AS CMPL_CNT
			FROM 
			(
				SELECT CT.COMPANY_CD
	                 , CT.BU_CD
	                 , ISNULL (CT.REP_ITEM_GROUP_CD, ' ') AS REP_ITEM_GROUP_CD 
	                 , ISNULL (CT.REP_ITEM_GROUP_CD, ' ') AS REP_ITEM_GROUP_CD_NM 
	                 , ISNULL (CT.REP_ITEM_GROUP_NM, ' ') AS REP_ITEM_GROUP_NM 
	                 , ISNULL (CT.REP_ITEM_GROUP_NM, ' ') AS REP_ITEM_GROUP_NM_NM 
	                 , ISNULL (CT.ROUTING_ID, ' ')        AS ROUTING_ID
	                 , ISNULL (CT.ROUTING_ID, ' ')        AS ROUTING_ID_NM
	                 , ISNULL (CT.REP_CUST_GROUP_CD, ' ') AS REP_CUST_GROUP_CD
	                 , ISNULL (CT.REP_CUST_GROUP_CD, ' ') AS REP_CUST_GROUP_CD_NM
	                 , ISNULL (CT.REP_CUST_GROUP_NM, ' ') AS REP_CUST_GROUP_NM
	                 , ISNULL (CT.REP_CUST_GROUP_NM, ' ') AS REP_CUST_GROUP_NM_NM
	                 , ISNULL (CT.CUST_GROUP_CD, ' ')     AS CUST_GROUP_CD
	                 , ISNULL (CT.CUST_GROUP_CD, ' ')     AS CUST_GROUP_CD_NM
	                 , ISNULL (CT.CUST_GROUP_NM, ' ')     AS CUST_GROUP_NM
	                 , ISNULL (CT.CUST_GROUP_NM, ' ')     AS CUST_GROUP_NM_NM
	                 , ISNULL (CT.ITEM_GROUP_CD, ' ')     AS ITEM_GROUP_CD
	                 , ISNULL (CT.ITEM_GROUP_CD, ' ')     AS ITEM_GROUP_CD_NM
	                 , ISNULL (CT.ITEM_GROUP_NM, ' ')     AS ITEM_GROUP_NM
	                 , ISNULL (CT.ITEM_GROUP_NM, ' ')     AS ITEM_GROUP_NM_NM
	                 , ISNULL (CT.ITEM_CD, ' ')           AS ITEM_CD
	                 , ISNULL (CT.ITEM_CD, ' ')           AS ITEM_CD_NM
	                 , ISNULL (CT.ITEM_NM, ' ')           AS ITEM_NM
	                 , ISNULL (CT.ITEM_NM, ' ')           AS ITEM_NM_NM
	                 , ISNULL (CT.SPEC, ' ')              AS SPEC
	                 , ISNULL (CT.SPEC, ' ')              AS SPEC_NM
	                 , ISNULL (CT.DRAW_NO, ' ')           AS DRAW_NO
	                 , ISNULL (CT.DRAW_NO, ' ')           AS DRAW_NO_NM
	                 , ISNULL (CT.ITEM_TYPE, ' ')         AS ITEM_TYPE_CD
	                 , ISNULL (CT.ITEM_TYPE, ' ')         AS ITEM_TYPE_CD_NM
	                 , ISNULL (CT.ITEM_TYPE_NM, ' ')      AS ITEM_TYPE_NM
	                 , ISNULL (CT.ITEM_TYPE_NM, ' ')      AS ITEM_TYPE_NM_NM
	                 , ISNULL (CT.SALES_ORG_LVL4_CD, ' ') AS SALES_ORG_LVL4_CD
	                 , ISNULL (CT.SALES_ORG_LVL4_CD, ' ') AS SALES_ORG_LVL4_CD_NM
	                 , ISNULL (CT.SALES_ORG_LVL4_NM, ' ') AS SALES_ORG_LVL4_NM
	                 , ISNULL (CT.SALES_ORG_LVL4_NM, ' ') AS SALES_ORG_LVL4_NM_NM
	                 , ISNULL (CT.SALES_ORG_LVL5_CD, ' ') AS SALES_ORG_LVL5_CD
	                 , ISNULL (CT.SALES_ORG_LVL5_CD, ' ') AS SALES_ORG_LVL5_CD_NM
	                 , ISNULL (CT.SALES_ORG_LVL5_NM, ' ') AS SALES_ORG_LVL5_NM
	                 , ISNULL (CT.SALES_ORG_LVL5_NM, ' ') AS SALES_ORG_LVL5_NM_NM
	                 , ISNULL (CT.CLEANING_YN, ' ') AS CLEANING_YN
	                 , ISNULL (CT.CLEANING_YN, ' ') AS CLEANING_YN_NM
	                 , ISNULL (CAST (CT.SALES_PRICE_KRW AS NVARCHAR(20)), CAST (CT.ITEM_COST_KRW AS NVARCHAR(20))) AS SALES_PRICE_KRW
	                 , ISNULL (CAST (CT.SALES_PRICE_KRW AS NVARCHAR(20)), CAST (CT.ITEM_COST_KRW AS NVARCHAR(20))) AS SALES_PRICE_KRW_NM
	                 , SUM(CASE WHEN ISP.FLAG = 'FQC_DATA' THEN QTY ELSE NULL END) AS FQC_DATA
	                 , SUM(CASE 
	                           WHEN ISP.RELEASE_DATE BETWEEN @P_W0_REQ_STRT AND @P_W0_REQ_END 
	                           THEN ISP.DEFECT_QTY 
	                           ELSE NULL 
	                         END) AS W0_DEFECT_QTY
	                 , SUM(CASE 
	                           WHEN ISP.RELEASE_DATE BETWEEN @P_W0_REQ_STRT AND @P_W0_REQ_END 
	                           THEN (ISP.GOODS_QTY - ISP.SPEC_QTY) 
	                           ELSE NULL 
	                         END) AS W0_CMPL_QTY
	                 , SUM(CASE 
	                           WHEN ISP.RELEASE_DATE BETWEEN @P_W0_REQ_STRT AND @P_W0_REQ_END 
	                           THEN ISP.SPEC_QTY 
	                           ELSE NULL 
	                         END) AS W0_SPEC_QTY
					#if($_parameter.prodPlan == "N")
						 #foreach( $i in $weekArr2 )
						 #set($j = $i - 1)
		                 , SUM(CASE WHEN ISP.FLAG = 'W_${j}' AND ISP.YEARWEEK = @P_W${j}_WEEK THEN ISP.QTY ELSE NULL END ) AS W${j}_PL_QTY 
		                 , CASE WHEN SUM ( CASE WHEN ISP.FLAG = 'W_${j}' AND ISP.YEARWEEK = @P_W${j}_WEEK THEN ISP.QTY ELSE NULL END ) <![CDATA[>]]> 0
		                        THEN 1
		                        ELSE 0
		                    END W${j}_PL_CNT
		                 , SUM(CASE WHEN ISP.RELEASE_DATE  BETWEEN @P_W${j}_REQ_STRT AND @P_W${j}_REQ_END 
		                             THEN ISP.GOODS_QTY 
		                           	 ELSE NULL 
		                         END
		                       ) AS W${j}_GOODS_QTY
		                       
		                 , CASE WHEN @{fromWeek} <![CDATA[<=]]> '201939' THEN NULL  
		                        WHEN ISNULL(SUM(CASE WHEN ISP.FLAG = 'W_${i}_PERFORM' THEN ISP.CMPL_QTY ELSE NULL END), 0) - ISNULL(SUM(CASE WHEN ISP.FLAG = 'W_${i}_PLAN' THEN ISP.QTY ELSE NULL END), 0) <![CDATA[>]]> 0
							    THEN ISNULL(SUM(CASE WHEN ISP.FLAG = 'W_${i}_PERFORM' THEN ISP.CMPL_QTY ELSE NULL END), 0) - ISNULL(SUM(CASE WHEN ISP.FLAG = 'W_${i}_PLAN' THEN ISP.QTY ELSE NULL END), 0)
							   ELSE NULL
						   END W${i}_PREPRODUCTION_QTY
		                 , CASE WHEN SUM(CASE WHEN ISP.FLAG = 'W_${j}' AND ISP.YEARWEEK = @P_W${j}_WEEK THEN ISP.QTY ELSE 0 END ) = 0 THEN NULL 
		                        ELSE CASE WHEN 
						             ((
						             	ISNULL(
						             			CASE WHEN @{fromWeek} <![CDATA[<=]]> '201939' THEN NULL
						             				 WHEN ISNULL(SUM(CASE WHEN ISP.FLAG = 'W_${i}_PERFORM' THEN ISP.CMPL_QTY ELSE NULL END), 0) - ISNULL(SUM(CASE WHEN ISP.FLAG = 'W_${i}_PLAN' THEN ISP.QTY ELSE NULL END), 0) <![CDATA[>]]> 0
													 THEN ISNULL(SUM(CASE WHEN ISP.FLAG = 'W_${i}_PERFORM' THEN ISP.CMPL_QTY ELSE NULL END), 0) - ISNULL(SUM(CASE WHEN ISP.FLAG = 'W_${i}_PLAN' THEN ISP.QTY ELSE NULL END), 0)
													 ELSE NULL
												END, 0) 
										+
										ISNULL(SUM (CASE WHEN ISP.RELEASE_DATE BETWEEN @P_W${j}_REQ_STRT AND @P_W${j}_REQ_END 
							                             THEN ISP.GOODS_QTY 
							                             ELSE NULL 
													 END), 0)
									) / NULLIF(SUM(CASE WHEN ISP.FLAG = 'W_${j}' AND ISP.YEARWEEK = @P_W${j}_WEEK THEN ISP.QTY ELSE NULL END), 0)) * 100 <![CDATA[<]]> @P_UN_RATE 
										THEN 1
										ELSE NULL
								 	END
						    END UN${j}_CNT			
		                 , CASE WHEN SUM(CASE WHEN ISP.FLAG = 'W_${j}' AND ISP.YEARWEEK = @P_W${j}_WEEK THEN ISP.QTY ELSE 0 END ) = 0 THEN NULL 
		                        ELSE CASE WHEN ISNULL(SUM(CASE WHEN ISP.FLAG = 'W_${j}' AND ISP.YEARWEEK = @P_W${j}_WEEK THEN ISP.QTY ELSE NULL END), 0) = 0 
			                             AND
			                             SUM(CASE WHEN ISP.RELEASE_DATE  BETWEEN @P_W${j}_REQ_STRT AND @P_W${j}_REQ_END 
					                              THEN ISP.GOODS_QTY 
					                           	  ELSE 0 
					                          END
					                       ) <![CDATA[>]]> 0 THEN 1
						                WHEN 
						                 ((
						                 	ISNULL(
						                 			CASE WHEN @{fromWeek} <![CDATA[<=]]> '201939' THEN NULL
						                 			     WHEN ISNULL(SUM(CASE WHEN ISP.FLAG = 'W_${i}_PERFORM' THEN ISP.CMPL_QTY ELSE NULL END), 0) - ISNULL(SUM(CASE WHEN ISP.FLAG = 'W_${i}_PLAN' THEN ISP.QTY ELSE NULL END), 0) <![CDATA[>]]> 0
														 THEN ISNULL(SUM(CASE WHEN ISP.FLAG = 'W_${i}_PERFORM' THEN ISP.CMPL_QTY ELSE NULL END), 0) - ISNULL(SUM(CASE WHEN ISP.FLAG = 'W_${i}_PLAN' THEN ISP.QTY ELSE NULL END), 0)
														 ELSE NULL
										   			END, 0) 
										   	+
										   	ISNULL(SUM (CASE WHEN ISP.RELEASE_DATE BETWEEN @P_W${j}_REQ_STRT AND @P_W${j}_REQ_END 
							                                 THEN ISP.GOODS_QTY 
							                                 ELSE NULL 
														END), 0)
										  ) / NULLIF(SUM(CASE WHEN ISP.FLAG = 'W_${j}' AND ISP.YEARWEEK = @P_W${j}_WEEK THEN ISP.QTY ELSE NULL END), 0)) * 100 <![CDATA[>=]]> @P_UN_RATE 
												THEN 1
												ELSE NULL
						 			END 
						 	END OB${j}_CNT	      
						#end 
					#end
				FROM W_ITEM CT
				INNER JOIN W_INSP ISP WITH(NOLOCK)
		           ON CT.COMPANY_CD = ISP.COMPANY_CD
		          AND CT.BU_CD      = ISP.BU_CD
		          AND CT.ITEM_CD    = ISP.ITEM_CD
		        WHERE CT.COMPANY_CD = @{GV_COMPANY_CD}
		          AND CT.BU_CD      = @{GV_BU_CD}
		          AND CT.PROCUR_TYPE_CD IN ('MG', 'MH')
           	  	  AND CT.ITEM_TYPE IN ('10', '20')
		  		#if($_parameter.item_cd and $_parameter.item_cd != "")
		          AND CT.ITEM_CD IN ('$_parameter.item_cd.replace(",","','")')
		  		#elseif($_parameter.item_nm and $_parameter.item_nm != "")
		          AND (CT.ITEM_CD LIKE '%'+@{item_nm}+'%' OR CT.ITEM_NM LIKE '%'+@{item_nm}+'%')
		  		#end
		  		#if($_parameter.itemGroup and $_parameter.itemGroup != "")
		          AND CT.ITEM_GROUP_CD IN ('$_parameter.itemGroup.replace(",","','")')
		  		#end
		  		#if($_parameter.route and $_parameter.route != "")
		          AND CT.ROUTING_ID IN ('$_parameter.route.replace(",","','")')
		  		#end
				GROUP BY CT.COMPANY_CD, CT.BU_CD, CT.REP_ITEM_GROUP_CD, CT.REP_ITEM_GROUP_NM, CT.ROUTING_ID, CT.REP_CUST_GROUP_CD, CT.REP_CUST_GROUP_NM, CT.CUST_GROUP_CD, CT.CUST_GROUP_NM 
		               , CT.ITEM_GROUP_CD, CT.ITEM_GROUP_NM, CT.ITEM_CD, CT.ITEM_NM, CT.SPEC, CT.DRAW_NO, CT.ITEM_TYPE, CT.ITEM_TYPE_NM, CT.SALES_ORG_LVL4_CD, CT.SALES_ORG_LVL4_NM, CT.SALES_ORG_LVL5_CD
		               , CT.SALES_ORG_LVL5_NM, CT.SALES_PRICE_KRW, CT.CLEANING_YN, CT.ITEM_COST_KRW
			) A
		    WHERE 1 = 1
			#if($_parameter.cpRt and $_parameter.cpRt != "")
				#if($_parameter.cpRt == "UN")
		    	  AND UN0_CNT = 1
				#elseif($_parameter.cpRt == "OB")
		    	  AND OB0_CNT = 1
		  		#end
			#end
		    GROUP BY ROLLUP ( <include refid="include.getCdRollup"/> )
		    ORDER BY TMP_COL
			#foreach( $dimMap in $_parameter.dimList )
		    	, A.$dimMap.DIM_CD
			#end
		END; -->
    
    </select>
    
    <select id="prodPalnCmplSummarySelect" parameterType="map" resultType="map">
    	/****** [ snop.oprtKpi.prodPalnCmplSummarySelect ] ******/
    	BEGIN
		
		    DECLARE @P_UN_RATE NUMERIC (21, 6);
		    DECLARE @P_OB_RATE NUMERIC (21, 6);
		    DECLARE @P_EX_RATE NUMERIC (21, 6);
		
		    SELECT @P_UN_RATE = CAST (MAX (CASE WHEN CODE_CD = 'UN' THEN ATTB_1_CD ELSE NULL END) AS NUMERIC (21, 6))
		         , @P_OB_RATE = CAST (MAX (CASE WHEN CODE_CD = 'OB' THEN ATTB_1_CD ELSE NULL END) AS NUMERIC (21, 6))
		         , @P_EX_RATE = CAST (MAX (CASE WHEN CODE_CD = 'EX' THEN ATTB_1_CD ELSE NULL END) AS NUMERIC (21, 6))
		    FROM TB_MST_CODE
		    WHERE GROUP_CD = 'COMPLIANCE_RATE';
		
		    DECLARE @P_W0_REQ_STRT  NVARCHAR(8) = @{swFromDate};
		    DECLARE @P_W0_REQ_END   NVARCHAR(8) = @{swToDate};
		    DECLARE @P_W0_WEEK      NVARCHAR(6) = (SELECT YEARWEEK FROM TB_MST_CALENDAR WHERE YYYYMMDD = @{swFromDate});
		    
		    DECLARE @P_W1_REQ_STRT  NVARCHAR(8)  = CONVERT (NVARCHAR (30), DATEADD (DAY, -7, CAST (@P_W0_REQ_STRT AS DATE)), 112);
		    DECLARE @P_W1_REQ_END   NVARCHAR(8)  = CONVERT (NVARCHAR (30), DATEADD (DAY, -7, CAST (@P_W0_REQ_END  AS DATE)), 112);
		    DECLARE @P_W1_WEEK      NVARCHAR(6)  = (SELECT YEARWEEK FROM TB_MST_CALENDAR WHERE YYYYMMDD = CONVERT(NVARCHAR(8), DATEADD(DAY, -7, CAST(@{swFromDate} AS DATE)), 112));
		    DECLARE @P_W1_REQ_STRT2 NVARCHAR(8)  = CONVERT (NVARCHAR (30), DATEADD (DAY, 4, CAST (@P_W1_REQ_STRT AS DATE)), 112);
		    
		    WITH W_ITEM AS 
			(
			    SELECT IT.COMPANY_CD
         , IT.BU_CD
         , CT.REP_CUST_GROUP_CD
         , CT.REP_CUST_GROUP_NM
         , CT.CUST_GROUP_CD
         , CT.CUST_GROUP_NM
         , IG.REP_ITEM_GROUP_CD
         , RG.REP_ITEM_GROUP_NM
         , IT.ITEM_GROUP_CD
         , IG.ITEM_GROUP_NM
         , IT.ITEM_CD
         , IT.ITEM_NM
         , IT.ITEM_TYPE
         , CASE WHEN 'ko' = @{GV_LANG} THEN CD.CODE_NM_KR
                WHEN 'cn' = @{GV_LANG} THEN CD.CODE_NM_CN
                ELSE CD.CODE_NM
           END ITEM_TYPE_NM
         , IT.SPEC
         , IT.DRAW_NO
         , IP.ROUTING_ID
         , IP.MFG_LT
         , IP.PUR_LT
         , IP.SS_QTY
         , CT.CUST_CD
         , CT.CUST_NM
         , CT.COUNTRY_CD
         , CT.CURRENCY
         , CT.DEAL_TYPE
         , CT.PAY_METH
         , IT.UOM_CD
         , CT.BIZ_GROUP_CD
         , CT.BIZ_GROUP_NM
         , IG.KEY_GROUP_YN
         , IC.SALES_PRICE_KRW
         , IC.SALES_ORG_LVL4_CD
         , SO.SALES_ORG_LVL4_NM
         , IC.SALES_ORG_LVL5_CD
         , SO.SALES_ORG_LVL5_NM
         , IP.PROCUR_TYPE
         , IP.PROCUR_TYPE_CD
         , IT.CPFR_YN
         , IG.UPPER_ITEM_GROUP_CD
         , IG.UPPER_ITEM_GROUP_NM
         , ISNULL(IT.SS_YN, 'N') AS SS_YN
         , IT.FIREWORK_YN
         , CASE WHEN MC1.CODE_CD IS NULL THEN 'N' ELSE 'Y' END AS CLEANING_YN
         , IP.SS_QTY_DISP
         , IT.ITEM_COST_KRW
         , IT.BEF_LAST_GR_AVG_QTY
	     , IT.BEF_LAST_PROD_AVG_QTY
	     , IT.LAST_GR_AVG_QTY
	     , IT.LAST_PROD_AVG_QTY
	     , IT.SBS_QTY
      FROM TB_MST_ITEM  IT WITH(NOLOCK)
      LEFT OUTER JOIN TB_MST_REP_CUST RC WITH(NOLOCK)
        ON RC.COMPANY_CD    = IT.COMPANY_CD
       AND RC.BU_CD         = IT.BU_CD
       AND RC.REP_CUST_CD   = IT.REP_CUST_CD
      LEFT OUTER JOIN TB_MAP_ITEM_CUST_GROUP IC WITH(NOLOCK)
        ON IC.COMPANY_CD    = IT.COMPANY_CD
       AND IC.BU_CD         = IT.BU_CD
       AND IC.ITEM_CD       = IT.ITEM_CD
       AND IC.CUST_GROUP_CD = RC.CUST_GROUP_CD
      LEFT OUTER JOIN TB_MST_ITEM_GROUP IG WITH(NOLOCK)
        ON IG.COMPANY_CD    = IT.COMPANY_CD
       AND IG.BU_CD         = IT.BU_CD
       AND IG.ITEM_GROUP_CD = IT.ITEM_GROUP_CD
      LEFT OUTER JOIN TB_MST_REP_ITEM_GROUP RG WITH(NOLOCK)
        ON RG.COMPANY_CD    = IG.COMPANY_CD
       AND RG.BU_CD         = IG.BU_CD
       AND RG.REP_ITEM_GROUP_CD = IG.REP_ITEM_GROUP_CD
      LEFT OUTER JOIN (SELECT COMPANY_CD 
                            , BU_CD 
                            , ITEM_CD 
                            , MAX (ROUTING_ID)  AS ROUTING_ID 
                            , MAX (PUR_LT)      AS PUR_LT
                            , MAX (MFG_LT)      AS MFG_LT
                            , SUM (SS_QTY)      AS SS_QTY
                            , MAX (PROCUR_TYPE) AS PROCUR_TYPE_CD
                            , (
							 	SELECT CASE WHEN 'ko' = @{GV_LANG} THEN CODE_NM_KR
							                WHEN 'cn' = @{GV_LANG} THEN CODE_NM_CN
							                ELSE CODE_NM
							           END AS CODE_NM
								FROM TB_MST_CODE WITH(NOLOCK)
								WHERE GROUP_CD = 'PROCUR_TYPE'
							  	  AND CODE_CD = MAX (PROCUR_TYPE)
							  	  AND USE_FLAG = 'Y'
							   ) AS PROCUR_TYPE
							, MAX(RCPT_SL_CD) AS RCPT_SL_CD
							, MAX(SS_QTY_DISP) AS SS_QTY_DISP
                         FROM TB_MST_ITEM_PLANT WITH(NOLOCK) 
                         WHERE PLANT_CD = 'WF01'
  #if($_parameter.procurType and $_parameter.procurType != "")
                        AND PROCUR_TYPE IN ('$_parameter.procurType.replace(",","','")')
  #end
  #if($_parameter.route and $_parameter.route != "")
       AND ROUTING_ID IN ('$_parameter.route.replace(",","','")')
  #end
                        GROUP BY COMPANY_CD
                               , BU_CD
                               , ITEM_CD) IP
        ON IT.COMPANY_CD    = IP.COMPANY_CD
       AND IT.BU_CD         = IP.BU_CD
       AND IT.ITEM_CD       = IP.ITEM_CD
      LEFT OUTER JOIN TB_MST_CUSTOMER CT WITH(NOLOCK) 
        ON IT.COMPANY_CD    = CT.COMPANY_CD
       AND IT.BU_CD         = CT.BU_CD 
       AND IT.REP_CUST_CD   = CT.CUST_CD
      LEFT OUTER JOIN UV_MAP_SALES_ORG SO
        ON IT.COMPANY_CD        = SO.COMPANY_CD
       AND IT.BU_CD             = SO.BU_CD
       AND IC.SALES_ORG_LVL4_CD = SO.SALES_ORG_LVL4_CD
       AND IC.SALES_ORG_LVL5_CD = SO.SALES_ORG_LVL5_CD
      LEFT OUTER JOIN TB_MST_CODE CD WITH(NOLOCK)
        ON CD.GROUP_CD = 'ITEM_TYPE'
       AND CD.CODE_CD  = IT.ITEM_TYPE
       AND CD.USE_FLAG = 'Y'
      LEFT OUTER JOIN TB_MST_CODE MC1 WITH(NOLOCK)
		ON MC1.BU_CD = IP.BU_CD
 	   AND MC1.GROUP_CD = 'CL_SL_CD'
 	   AND MC1.CODE_CD = IP.RCPT_SL_CD
 	   AND MC1.USE_FLAG = 'Y'
     WHERE IT.COMPANY_CD    = @{GV_COMPANY_CD}
       AND IT.BU_CD         = @{GV_BU_CD}
  #if($_parameter.item_cd and $_parameter.item_cd != "")
       AND IT.ITEM_CD IN ('$_parameter.item_cd.replace(",","','")')
  #elseif($_parameter.item_nm and $_parameter.item_nm != "")
       AND (IT.ITEM_CD LIKE '%'+@{item_nm}+'%' OR IT.ITEM_NM LIKE '%'+@{item_nm}+'%')
  #end
  
  #if($_parameter.itemGroup and $_parameter.itemGroup != "")
       AND IT.ITEM_GROUP_CD IN ('$_parameter.itemGroup.replace(",","','")')
  #end
  
  #if($_parameter.reptCustGroup and $_parameter.reptCustGroup != "")
       AND CT.REP_CUST_GROUP_CD IN ('$_parameter.reptCustGroup.replace(",","','")')
  #end
  #if($_parameter.custGroup and $_parameter.custGroup != "")
       AND CT.CUST_GROUP_CD IN ('$_parameter.custGroup.replace(",","','")')
  #end
  #if($_parameter.salesOrgLvl5Cd and $_parameter.salesOrgLvl5Cd != "")
       AND IC.SALES_ORG_LVL5_CD IN ('$_parameter.salesOrgLvl5Cd.replace(",","','")')
  #end
  #if($_parameter.itemType and $_parameter.itemType != "")
       AND IT.ITEM_TYPE IN ('$_parameter.itemType.replace(",","','")')
  #end
  #if($_parameter.upItemGroup and $_parameter.upItemGroup != "")
       AND IG.UPPER_ITEM_GROUP_CD IN ('$_parameter.upItemGroup.replace(",","','")')
  #end
  #if($_parameter.procurType and $_parameter.procurType != "")
       AND IP.PROCUR_TYPE_CD IN ('$_parameter.procurType.replace(",","','")')
  #end
  
  #if($_parameter.cpfrYn and $_parameter.cpfrYn != "")
       AND ISNULL(IT.CPFR_YN, 'N') IN ('$_parameter.cpfrYn.replace(",","','")')
  #end
  #if($_parameter.ssYn and $_parameter.ssYn != "")
       AND ISNULL(IT.SS_YN, 'N') IN ('$_parameter.ssYn.replace(",","','")')
  #end
  #if($_parameter.validYn and $_parameter.validYn != "")
       AND ISNULL(IT.USE_FLAG, 'N') IN ('$_parameter.validYn.replace(",","','")')
  #end
			),
			W_CODE AS 
			(
				#set($_parameter.groupCd = "TEAM_CD")
		      	#set($_parameter.buAllYn = "Y")
		      	<include refid="include.mstCode"/>
			)
			, W_INSP AS 
			(
			    SELECT ISP.COMPANY_CD
			         , ISP.BU_CD
			         , ISP.ITEM_CD
			         , ISP.LOT_SIZE
			         , ISP.INSP_QTY
			         , ISP.GOODS_QTY
			         , ISP.DEFECT_QTY
			         , (ISP.GOODS_QTY - ISP.SPEC_QTY) AS CMPL_QTY
			         , ISP.SPEC_QTY
			         , NULL AS ADJ_INSP_REQ_DATE
			         , ISP.RELEASE_DATE
			         , NULL YEARWEEK
			         , NULL QTY
			         , NULL AS FLAG
			    FROM TB_DYN_INSPECTION ISP WITH (NOLOCK)
			    WHERE ISP.COMPANY_CD = @{GV_COMPANY_CD}
			      AND ISP.BU_CD      = @{GV_BU_CD}
			      AND ISP.PLANT_CD   = 'WF01' 
			      AND DEL_FLAG       = 'N'
			      AND RELEASE_DATE BETWEEN @P_W1_REQ_STRT AND @P_W0_REQ_END
				UNION ALL
	          	SELECT DGP.COMPANY_CD
	                 , DGP.BU_CD
	                 , DGP.ITEM_CD
	                 , DGP.GR_QTY AS LOT_SIZE
	                 , DGP.GR_QTY AS INSP_QTY
	                 , DGP.GR_QTY AS GOODS_QTY
	                 , NULL AS DEFECT_QTY
	                 , DGP.GR_QTY AS CMPL_QTY
	                 , NULL AS SPEC_QTY
	                 , NULL AS ADJ_INSP_REQ_DATE
	                 , DGP.GR_DATE AS RELEASE_DATE
	                 , NULL YEARWEEK
	                 , NULL QTY
	                 , NULL FLAG
				FROM TB_DYN_GR_PROD DGP WITH(NOLOCK)
	            WHERE DGP.COMPANY_CD = @{GV_COMPANY_CD}
	              AND DGP.BU_CD = @{GV_BU_CD}
	              AND DGP.PLANT_CD = 'WF01'
	              AND DGP.GR_DATE BETWEEN @P_W1_REQ_STRT AND @P_W0_REQ_END
	              AND EXISTS (
	                         	SELECT 1
	                           	FROM TB_MST_ITEM_PLANT MIP WITH(NOLOCK)
	                          	WHERE MIP.COMPANY_CD = DGP.COMPANY_CD
	                              AND MIP.BU_CD = DGP.BU_CD
	                              AND MIP.PLANT_CD = DGP.PLANT_CD
	                              AND MIP.ITEM_CD = DGP.ITEM_CD
	                              AND MIP.ITEM_TYPE = '20'
	                              AND MIP.PROCUR_TYPE IN ('MG', 'MH')
	                         )  
			    UNION ALL
			    SELECT PP.COMPANY_CD
			         , PP.BU_CD
			         , PP.ITEM_CD
			         , NULL
			         , NULL
			         , NULL
			         , NULL
			         , NULL
			         , NULL
			         , NULL
			         , NULL
			         , YEARWEEK
			         , PP.QTY
			         , 'W_0' AS FLAG
	          	FROM TB_DYN_PROD_PLAN PP WITH(NOLOCK)
          		WHERE COMPANY_CD = @{GV_COMPANY_CD}
			      AND BU_CD      = @{GV_BU_CD} 
			      AND YEARWEEK   = @P_W0_WEEK
		        /*선행생산 실적*/  
				UNION ALL
				SELECT ISP.COMPANY_CD
				     , ISP.BU_CD
				     , ISP.ITEM_CD
				     , NULL
				     , NULL
				     , NULL
				     , NULL
				     , ISP.GOODS_QTY AS CMPL_QTY
				     , NULL
				     , NULL
				     , ISP.RELEASE_DATE
				     , NULL YEARWEEK
				     , NULL QTY
				     , 'W_1_PERFORM' FLAG
				FROM TB_DYN_INSPECTION ISP WITH (NOLOCK)
				WHERE ISP.COMPANY_CD = @{GV_COMPANY_CD}
			  	  AND ISP.BU_CD      = @{GV_BU_CD} 
			  	  AND ISP.PLANT_CD   = 'WF01'
			  	  AND DEL_FLAG       = 'N'
			  	  AND RELEASE_DATE BETWEEN @P_W1_REQ_STRT2 AND @P_W1_REQ_END
				UNION ALL
          		SELECT DGP.COMPANY_CD
	                 , DGP.BU_CD
	                 , DGP.ITEM_CD
	                 , NULL
	                 , NULL
	                 , NULL
	                 , NULL
	                 , DGP.GR_QTY AS CMPL_QTY
	                 , NULL
	                 , NULL
	                 , DGP.GR_DATE AS RELEASE_DATE
	                 , NULL YEARWEEK
	                 , NULL QTY
	                 , 'W_1_PERFORM' FLAG
				FROM TB_DYN_GR_PROD DGP WITH(NOLOCK)
	           	WHERE DGP.COMPANY_CD = @{GV_COMPANY_CD}
	              AND DGP.BU_CD = @{GV_BU_CD} 
	              AND DGP.PLANT_CD = 'WF01'
	              AND DGP.GR_DATE BETWEEN @P_W1_REQ_STRT2 AND @P_W1_REQ_END
	              AND EXISTS (
                         		SELECT 1
                           		FROM TB_MST_ITEM_PLANT MIP WITH(NOLOCK)
                          		WHERE MIP.COMPANY_CD = DGP.COMPANY_CD
	                              AND MIP.BU_CD = DGP.BU_CD
	                              AND MIP.PLANT_CD = DGP.PLANT_CD
	                              AND MIP.ITEM_CD = DGP.ITEM_CD
	                              AND MIP.ITEM_TYPE = '20'
	                              AND MIP.PROCUR_TYPE IN ('MG', 'MH')
                        	 )
	          
	          	/*선행생산 계획*/
	          	UNION ALL
	          	SELECT PP.COMPANY_CD
			         , PP.BU_CD
			         , PP.ITEM_CD
			         , NULL
			         , NULL
			         , NULL
			         , NULL
			         , NULL
			         , NULL
			         , NULL
			         , NULL
			         , NULL
			         , PP.QTY
			         , 'W_1_PLAN' AS FLAG
	          	FROM TB_HIS_APS_PROD_PLAN_DAILY PP WITH(NOLOCK)
				WHERE PP.PLAN_ID = @P_W1_REQ_STRT2
	         	  AND PP.YYYYMMDD BETWEEN @P_W1_REQ_STRT2 AND @P_W1_REQ_END
			)
		    SELECT TEAM_CD
		         , CASE WHEN TEAM_CD IS NULL THEN 'Total' ELSE TEAM_CD_NM END AS TEAM_CD_NM
		         , TEAM_NM
		         , CASE
		             WHEN TEAM_CD IS NOT NULL 
		             THEN CASE WHEN TEAM_NM IS NULL THEN 'Sub Total' ELSE TEAM_NM_NM END
		             ELSE CASE WHEN TEAM_NM IS NULL THEN '' ELSE TEAM_NM_NM END
		           END AS TEAM_NM_NM
		         , ROUTING_ID
		         , CASE
		               WHEN TEAM_NM IS NOT NULL THEN CASE WHEN ROUTING_ID IS NULL THEN 'Sub Total' ELSE ROUTING_ID_NM END
		               ELSE CASE WHEN ROUTING_ID IS NULL THEN '' ELSE ROUTING_ID_NM END
		           END AS ROUTING_ID_NM
		         , GROUPING_ID (TEAM_CD, TEAM_NM, ROUTING_ID) AS GRP_LVL_ID
		         , SUM ( ISNULL(UN_CNT, 0) + ISNULL(OB_CNT, 0))  AS ITEM_CNT
		         , ISNULL(SUM (PLAN_CNT), 0) AS PLAN_CNT
		         , ISNULL(SUM (PL_QTY), 0) AS PL_QTY
		         , ISNULL(SUM (OB_CNT), 0) AS OB_CNT
		         , ISNULL(SUM (UN_CNT), 0) AS UN_CNT		         
		         , ISNULL(SUM (OB_CNT), 0) + ISNULL(SUM (UN_CNT), 0) AS TOT_CNT
		         , ISNULL(SUM (OB_CNT), 0) / NULLIF(CAST(ISNULL(SUM (OB_CNT), 0) + ISNULL(SUM (UN_CNT), 0) AS NUMERIC(21, 5)), 0) * 100 AS OB_RATE
		         , ISNULL(SUM (UN_CNT), 0) / NULLIF(CAST(ISNULL(SUM (OB_CNT), 0) + ISNULL(SUM (UN_CNT), 0) AS NUMERIC(21, 5)), 0) * 100 AS UN_RATE
			FROM 
			(
				SELECT CT.COMPANY_CD
		             , CT.BU_CD
		             , ISNULL (CT.ITEM_CD, ' ')    AS ITEM_CD
		             , ISNULL (ORG.TEAM_CD, ' ')   AS TEAM_CD
		             , ISNULL (ORG.TEAM_CD, ' ')   AS TEAM_CD_NM
		             , ISNULL (TEM.CODE_NM, ' ')   AS TEAM_NM
		             , ISNULL (TEM.CODE_NM, ' ')   AS TEAM_NM_NM
		             , ISNULL (CT.ROUTING_ID, ' ') AS ROUTING_ID
		             , ISNULL (CT.ROUTING_ID, ' ') AS ROUTING_ID_NM
		             , COUNT (CT.ITEM_CD) AS ITEM_CNT
		             , SUM (CASE WHEN ISP.YEARWEEK = @P_W0_WEEK AND ISP.FLAG = 'W_0' THEN ISP.QTY ELSE NULL END) AS PL_QTY
	             	 , CASE WHEN SUM ( CASE WHEN ISP.YEARWEEK = @P_W0_WEEK AND ISP.FLAG = 'W_0' THEN ISP.QTY ELSE NULL END ) <![CDATA[>]]> 0
		                    THEN 1
		                    ELSE 0
		                END PLAN_CNT 
		             , SUM (
		             			CASE WHEN ISP.RELEASE_DATE  BETWEEN @P_W0_REQ_STRT AND @P_W0_REQ_END
		                             THEN ISP.GOODS_QTY
		                             ELSE NULL
		                    	 END
		                   ) AS GOODS_QTY
	             	, CASE WHEN SUM (CASE WHEN ISP.YEARWEEK = @P_W0_WEEK AND ISP.FLAG = 'W_0' THEN ISP.QTY ELSE 0 END) = 0 THEN NULL
	             	       ELSE CASE WHEN ISNULL(SUM(CASE WHEN ISP.FLAG = 'W_0' AND ISP.YEARWEEK = @P_W0_WEEK THEN ISP.QTY ELSE NULL END), 0) = 0 
	                             	 AND
	                             SUM(CASE WHEN ISP.RELEASE_DATE  BETWEEN @P_W0_REQ_STRT AND @P_W0_REQ_END 
			                              THEN ISP.GOODS_QTY 
			                           	  ELSE 0 
			                          END
			                       ) <![CDATA[>]]> 0 THEN NULL
			                WHEN 
			                 ((
			                 	ISNULL(
			                 			CASE WHEN @{fromWeek} <![CDATA[<=]]> '201939' THEN NULL
			                 			     WHEN ISNULL(SUM(CASE WHEN ISP.FLAG = 'W_1_PERFORM' THEN ISP.CMPL_QTY ELSE NULL END), 0) - ISNULL(SUM(CASE WHEN ISP.FLAG = 'W_1_PLAN' THEN ISP.QTY ELSE NULL END), 0) <![CDATA[>]]> 0
											 THEN ISNULL(SUM(CASE WHEN ISP.FLAG = 'W_1_PERFORM' THEN ISP.CMPL_QTY ELSE NULL END), 0) - ISNULL(SUM(CASE WHEN ISP.FLAG = 'W_1_PLAN' THEN ISP.QTY ELSE NULL END), 0)
											 ELSE NULL
							   			END, 0) 
							   	+
							   	ISNULL(SUM (CASE WHEN ISP.RELEASE_DATE  BETWEEN @P_W0_REQ_STRT AND @P_W0_REQ_END 
				                                 THEN ISP.GOODS_QTY 
				                                 ELSE NULL 
											END), 0)
							  ) / NULLIF(SUM(CASE WHEN ISP.FLAG = 'W_0' AND ISP.YEARWEEK = @P_W0_WEEK THEN ISP.QTY ELSE NULL END), 0)) * 100 <![CDATA[<]]> @P_UN_RATE 
									THEN 1
									ELSE NULL
					 		END
					 	END UN_CNT			
	                 , CASE WHEN SUM (CASE WHEN ISP.YEARWEEK = @P_W0_WEEK AND ISP.FLAG = 'W_0' THEN ISP.QTY ELSE 0 END) = 0 THEN NULL
	                        ELSE CASE WHEN ISNULL(SUM(CASE WHEN ISP.FLAG = 'W_0' AND ISP.YEARWEEK = @P_W0_WEEK THEN ISP.QTY ELSE NULL END), 0) = 0 
	                             AND
	                             SUM(CASE WHEN ISP.RELEASE_DATE  BETWEEN @P_W0_REQ_STRT AND @P_W0_REQ_END 
			                              THEN ISP.GOODS_QTY 
			                           	  ELSE 0 
			                          END
			                       ) <![CDATA[>]]> 0 THEN 1
			                WHEN 
			                 ((
			                 	ISNULL(
			                 			CASE WHEN @{fromWeek} <![CDATA[<=]]> '201939' THEN NULL
			                 			     WHEN ISNULL(SUM(CASE WHEN ISP.FLAG = 'W_1_PERFORM' THEN ISP.CMPL_QTY ELSE NULL END), 0) - ISNULL(SUM(CASE WHEN ISP.FLAG = 'W_1_PLAN' THEN ISP.QTY ELSE NULL END), 0) <![CDATA[>]]> 0
											 THEN ISNULL(SUM(CASE WHEN ISP.FLAG = 'W_1_PERFORM' THEN ISP.CMPL_QTY ELSE NULL END), 0) - ISNULL(SUM(CASE WHEN ISP.FLAG = 'W_1_PLAN' THEN ISP.QTY ELSE NULL END), 0)
											 ELSE NULL
							   			END, 0) 
							   	+
							   	ISNULL(SUM (CASE WHEN ISP.RELEASE_DATE  BETWEEN @P_W0_REQ_STRT AND @P_W0_REQ_END 
				                                 THEN ISP.GOODS_QTY 
				                                 ELSE NULL 
											END), 0)
							  ) / NULLIF(SUM(CASE WHEN ISP.FLAG = 'W_0' AND ISP.YEARWEEK = @P_W0_WEEK THEN ISP.QTY ELSE NULL END), 0)) * 100 <![CDATA[>=]]> @P_UN_RATE 
									THEN 1
									ELSE NULL
							END
					 	END OB_CNT	      
				FROM W_ITEM CT
		        INNER JOIN W_INSP ISP WITH(NOLOCK)
		           ON CT.COMPANY_CD = ISP.COMPANY_CD
		          AND CT.BU_CD      = ISP.BU_CD
		          AND CT.ITEM_CD    = ISP.ITEM_CD
		        INNER JOIN TB_MST_ORG_SCOPE ITEM
		           ON CT.COMPANY_CD = ITEM.COMPANY_CD
		          AND CT.BU_CD      = ITEM.BU_CD
		          AND LTRIM(RTRIM(CT.ROUTING_ID)) = LTRIM(RTRIM(ITEM.DATA_SCOPE_ID))
		          AND ITEM.DEL_FLAG != 'Y' 
		          AND ITEM.USE_FLAG != 'N' 
		        LEFT OUTER JOIN UV_MST_ORG ORG WITH (NOLOCK)
		          ON ITEM.COMPANY_CD = ORG.COMPANY_CD
		         AND ITEM.BU_CD      = ORG.BU_CD
		         AND ITEM.PART_CD    = ORG.PART_CD
		        LEFT OUTER JOIN W_CODE TEM
		          ON TEM.BU_CD    = ORG.BU_CD
		         AND TEM.CODE_CD  = ORG.TEAM_CD
		         AND TEM.GROUP_CD = 'TEAM_CD'
		        WHERE CT.COMPANY_CD = @{GV_COMPANY_CD}
		          AND CT.BU_CD      = @{GV_BU_CD}
		          AND CT.ITEM_TYPE IN ('10', '20')
				  AND EXISTS (
                          		SELECT 1
                            	FROM TB_MST_CODE MC WITH(NOLOCK)
                           		WHERE MC.BU_CD = ORG.BU_CD
                             	  AND MC.GROUP_CD = 'TEAM_CD'
                             	  AND MC.CODE_CD = ORG.TEAM_CD
	                              AND MC.USE_FLAG = 'Y'
	                              AND MC.ATTB_6_CD = 'Y'
                         	 )
				  AND EXISTS (
	                         	SELECT 1
	                           	FROM TB_MST_ITEM_PLANT MIP WITH(NOLOCK)
	                          	WHERE MIP.COMPANY_CD = CT.COMPANY_CD
	                              AND MIP.BU_CD = CT.BU_CD
	                              AND MIP.PLANT_CD = 'WF01'
	                              AND MIP.ITEM_CD = CT.ITEM_CD
	                              AND MIP.PROCUR_TYPE IN ('MG', 'MH')
	                         )   
				#if($_parameter.item_cd and $_parameter.item_cd != "")
		          AND CT.ITEM_CD IN ('$_parameter.item_cd.replace(",","','")')
		  		#elseif($_parameter.item_nm and $_parameter.item_nm != "")
		          AND (CT.ITEM_CD LIKE '%'+@{item_nm}+'%' OR CT.ITEM_NM LIKE '%'+@{item_nm}+'%')
		  		#end
		  		#if($_parameter.itemGroup and $_parameter.itemGroup != "")
		          AND CT.ITEM_GROUP_CD IN ('$_parameter.itemGroup.replace(",","','")')
		  		#end
		  		
				GROUP BY CT.COMPANY_CD, CT.BU_CD, CT.ITEM_CD, ORG.TEAM_CD, TEM.CODE_NM, CT.ROUTING_ID
			) A
		    GROUP BY ROLLUP ( (TEAM_CD, TEAM_CD_NM, TEAM_NM, TEAM_NM_NM), (ROUTING_ID, ROUTING_ID_NM) )
		    ORDER BY A.TEAM_CD_NM, A.TEAM_CD, A.TEAM_NM_NM, A.ROUTING_ID_NM, A.ROUTING_ID
		    
		END;
	
    </select>
    
    <select id="prodPalnCmplSummaryExcelSqlSelect" parameterType="map" resultType="map">
	/****** [ snop.oprtKpi.prodPalnCmplSummaryExcelSqlSelect ] ******/
		SELECT CASE WHEN A2.MENU_CD = @{popUpMenuCd} THEN 'Y' ELSE 'N' END AS USE_FLAG
		, A2.ACTION_CD
		FROM
		(
		  	SELECT BU_CD
		         , ROLE_CD
		  	FROM TB_MAP_USER_ROLE WITH(NOLOCK)
		  	WHERE USER_ID = @{GV_USER_ID}
		      AND BU_CD = @{GV_BU_CD}
		      AND USE_FLAG = 'Y'
		) A1
		INNER JOIN
		(
		  	SELECT COMPANY_CD
		         , BU_CD
		         , ROLE_CD
		         , MENU_CD
		         , ACTION_CD
		  	FROM TB_MAP_ROLE_MENU_ACTION WITH(NOLOCK)
		  	WHERE COMPANY_CD = @{GV_COMPANY_CD}
		      AND BU_CD = @{GV_BU_CD}
		      AND MENU_CD = @{popUpMenuCd}
		      AND ACTION_CD IN ('EXCEL','SQL')
		      AND USE_FLAG = 'Y'
		) A2
		ON A1.BU_CD = A2.BU_CD
		AND A1.ROLE_CD = A2.ROLE_CD
		GROUP BY A2.MENU_CD
		, A2.ACTION_CD
	
	</select>
</mapper>
